

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>storylines.plot &mdash; StoryLines  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #e7f2fa" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/StoryLines.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/plot.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/calc.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/color.html">Colors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/convert.html">Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/cut.html">Cutting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/fatband.html">Fatbands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/files.html">Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/group.html">Grouping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/png.html">PNG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/proj.html">Projection</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples/example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/faces.html">Tetrahedron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/fatband.html">Fatbands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/mandelbrot.html">Mandelbrot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/moebius.html">Moebius</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/project.html">Projection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/shortcut.html">Shortcuts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #e7f2fa" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">StoryLines</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">storylines.plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for storylines.plot</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2016-2026 Jan Berges</span>
<span class="c1"># This program is free software under the terms of the BSD Zero Clause License.</span>

<span class="sd">&quot;&quot;&quot;Figure object.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.calc</span><span class="w"> </span><span class="kn">import</span> <span class="n">power_of_ten</span><span class="p">,</span> <span class="n">xround_mantissa</span><span class="p">,</span> <span class="n">multiples</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.color</span><span class="w"> </span><span class="kn">import</span> <span class="n">Color</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">colorize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.convert</span><span class="w"> </span><span class="kn">import</span> <span class="n">inch</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">csv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.cut</span><span class="w"> </span><span class="kn">import</span> <span class="n">relevant</span><span class="p">,</span> <span class="n">shortcut</span><span class="p">,</span> <span class="n">cut2d</span><span class="p">,</span> <span class="n">jump</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fatband</span><span class="w"> </span><span class="kn">import</span> <span class="n">fatband</span><span class="p">,</span> <span class="n">miter_butt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">goto</span><span class="p">,</span> <span class="n">typeset</span><span class="p">,</span> <span class="n">rasterize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.group</span><span class="w"> </span><span class="kn">import</span> <span class="n">islands</span><span class="p">,</span> <span class="n">groups</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.png</span><span class="w"> </span><span class="kn">import</span> <span class="n">save</span>

<div class="viewcode-block" id="Plot">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Plot</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    width : float, default None</span>
<span class="sd">         Figure width in cm. A negative value is interpreted as the inner width</span>
<span class="sd">         (without left and right margins). If zero, the x-axis scale is set</span>
<span class="sd">         equal to the y-axis scale and the width is inferred from the height. By</span>
<span class="sd">         default, the single-column width for the chosen `style` is used.</span>
<span class="sd">    height : float, default None</span>
<span class="sd">         Figure height in cm. A negative value is interpreted as the inner</span>
<span class="sd">         height (without bottom and top margins). If zero, the y-axis scale is</span>
<span class="sd">         set equal to the x-axis scale and the height is inferred from the</span>
<span class="sd">         width. By default, it is inferred from `width` for a 4:3 aspect ratio.</span>
<span class="sd">    margin : float, default None</span>
<span class="sd">        Default margin in cm. If ``None``, margins are set automatically. This</span>
<span class="sd">        is not always the best option.</span>
<span class="sd">    xyaxes : bool, default True</span>
<span class="sd">        Draw x and y axes?</span>
<span class="sd">    style : str, default None</span>
<span class="sd">        Predefined style. Possible values are ``&#39;APS&#39;``, ``&#39;NanoLett&#39;``,</span>
<span class="sd">        ``&#39;NatCommun&#39;``, and ``&#39;Nature&#39;``. This changes some of the below</span>
<span class="sd">        default values.</span>
<span class="sd">    rounded : bool, default True</span>
<span class="sd">        Use ``round`` as default value for ``line cap`` and ``line join``?</span>
<span class="sd">        Otherwise the TikZ initial values ``miter`` and ``butt`` are used.</span>
<span class="sd">    **more</span>
<span class="sd">        Initial values of attributes (see below) or global TikZ options.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    left : float, default `margin`</span>
<span class="sd">        Left margin in cm.</span>
<span class="sd">    right : float, default `margin`</span>
<span class="sd">        Right margin in cm.</span>
<span class="sd">    bottom : float, default `margin`</span>
<span class="sd">        Bottom margin in cm.</span>
<span class="sd">    top : float, default `margin`</span>
<span class="sd">        Top margin in cm.</span>
<span class="sd">    margmin : float, default 0.15</span>
<span class="sd">        Minimum automatic margin in cm.</span>
<span class="sd">    ratio : float, default None</span>
<span class="sd">        Figure width divided by figure height. The desired aspect ratio is</span>
<span class="sd">        obtained by adding extra margins as needed.</span>
<span class="sd">    align : float, default 0.5</span>
<span class="sd">        If `ratio` is used, this value aligns the original plot relative to the</span>
<span class="sd">        new viewport. A value of ``0.0``, ``0.5``, and ``1.0`` moves it to the</span>
<span class="sd">        lower side, to the center, and to the upper side, respectively.</span>
<span class="sd">    xlabel, ylabel, zlabel : str, default None</span>
<span class="sd">        Axis labels.</span>
<span class="sd">    xticks, yticks, zticks : list, default None</span>
<span class="sd">        List of ticks, e.g., ``[0, (0.5, &#39;$\\\\frac12$&#39;), 1]``. If the label is</span>
<span class="sd">        ``None``, the tick mark is not drawn (but possibe grid lines are). If it</span>
<span class="sd">        otherwise evaluates to ``False``, the tick mark but no label is drawn.</span>
<span class="sd">    xmarks, ymarks, zmarks : bool, default True</span>
<span class="sd">        Show tick marks and labels?</span>
<span class="sd">    xlabels, ylabels, zlabels : bool, default True</span>
<span class="sd">        Show tick labels?</span>
<span class="sd">    xspacing, yspacing, zspacing : float, default 1.0</span>
<span class="sd">        Approximate tick spacing in cm.</span>
<span class="sd">    xstep, ystep, zstep : float, default None</span>
<span class="sd">        Exact tick increment.</span>
<span class="sd">    xminorticks, yminorticks : list, default None</span>
<span class="sd">        List of minor-tick positions. There is currently no intelligent way to</span>
<span class="sd">        set the minor ticks depending on the major ticks. However, minor ticks</span>
<span class="sd">        that fall on major ticks are omitted.</span>
<span class="sd">    xminormarks, yminormarks : bool, default False</span>
<span class="sd">        Show minor tick marks?</span>
<span class="sd">    xminorspacing, yminorspacing : float, default None</span>
<span class="sd">        Approximate minor-tick spacing in cm.</span>
<span class="sd">    xminorstep, yminorstep : float, default None</span>
<span class="sd">        Exact minor-tick increment.</span>
<span class="sd">    xmin, ymin, zmin : float, default None</span>
<span class="sd">        Lower axis limit.</span>
<span class="sd">    xmax, ymax, zmax : float, default None</span>
<span class="sd">        Upper axis limit.</span>
<span class="sd">    dleft, dright, dbottom, dtop : float, default 0.0</span>
<span class="sd">        Protrusion of x- and y-axis limits into margins in cm.</span>
<span class="sd">    xpadding, ypadding, zpadding : float, default 0.0</span>
<span class="sd">        Padding between data and axes in data units.</span>
<span class="sd">    xclose, yclose, zclose : bool, default False</span>
<span class="sd">        Place axis labels in space reserved for tick labels.</span>
<span class="sd">    xformat, yformat, zformat : function</span>
<span class="sd">        Tick formatter. Takes tick position as argument.</span>
<span class="sd">    lower : str, default &#39;blue&#39;</span>
<span class="sd">        Lower color of colorbar. Can also be of type ``Color`` as long as</span>
<span class="sd">        `upper` has the same type.</span>
<span class="sd">    upper : str, default &#39;red&#39;</span>
<span class="sd">        Upper color of colorbar. Can also be of type ``Color`` as long as</span>
<span class="sd">        `lower` has the same type.</span>
<span class="sd">    cmap : function, default None</span>
<span class="sd">        Colormap for colorbar used instead of `lower` and `upper`.</span>
<span class="sd">    title : str, default None</span>
<span class="sd">        Plot title.</span>
<span class="sd">    label : str, default None</span>
<span class="sd">        Subfigure label, e.g., ``&#39;a&#39;``.</span>
<span class="sd">    labelsize : int, default None</span>
<span class="sd">        Different font size for subfigure label in pt.</span>
<span class="sd">    labelformat : function, default None</span>
<span class="sd">        Formatter for subfigure label. Takes `label` as argument.</span>
<span class="sd">    labelopt : str, default &#39;inner sep=0pt, below right&#39;</span>
<span class="sd">        Label options, e.g., for orientation.</span>
<span class="sd">    labelpos : str, default &#39;LT&#39;</span>
<span class="sd">        Label position, a combination of ``lcrbmtLCRBMT`` or a tuple of data</span>
<span class="sd">        coordinates.</span>
<span class="sd">    lali : str, default &#39;center&#39;</span>
<span class="sd">        Alignment of legend entries.</span>
<span class="sd">    lbls : str, default &#39;\\\\\\\\baselineskip&#39;</span>
<span class="sd">        Line height of legend entries.</span>
<span class="sd">    lbox : bool, default False</span>
<span class="sd">        Draw box around legend?</span>
<span class="sd">    lcol : int, default 1</span>
<span class="sd">        Number of columns in legend.</span>
<span class="sd">    llen : str, default &#39;4mm&#39;</span>
<span class="sd">        Length of example lines next to labels.</span>
<span class="sd">    lopt : str, default None</span>
<span class="sd">        Legend options, e.g., for orientation.</span>
<span class="sd">    lpos : str, default &#39;cm&#39;</span>
<span class="sd">        Legend position, a combination of ``lcrbmtLCRBMT`` or a tuple of data</span>
<span class="sd">        coordinates.</span>
<span class="sd">    lput : bool, default True</span>
<span class="sd">        Draw legend?</span>
<span class="sd">    lrow : int, default 0</span>
<span class="sd">        Number of rows in legend.</span>
<span class="sd">    lsep : str, default None</span>
<span class="sd">        Space between legend title and entries, e.g., ``&#39;6pt&#39;``.</span>
<span class="sd">    ltop : str, default None</span>
<span class="sd">        Legend title. If `lbox` is used, you might want to prevent that TikZ</span>
<span class="sd">        pictures in the legend inherit the ``rounded corners`` of the box by</span>
<span class="sd">        prepending ``\\tikzset{sharp corners}`` to this value.</span>
<span class="sd">    lwid : float, default 4.0</span>
<span class="sd">        Width of legend columns in units of `llen`.</span>
<span class="sd">    tick : float, default 0.07</span>
<span class="sd">        Length of tick marks in cm.</span>
<span class="sd">    minortick : float, default 0.04</span>
<span class="sd">        Length of minor tick marks in cm.</span>
<span class="sd">    gap : float, default 0.15</span>
<span class="sd">        Gap between plot area and colorbar in cm.</span>
<span class="sd">    bar : float, default 0.15</span>
<span class="sd">        Width of color bar in cm.</span>
<span class="sd">    tip : float, default 0.1</span>
<span class="sd">        Overlap of axis tips in cm.</span>
<span class="sd">    xaxis : bool, default `xyaxes`</span>
<span class="sd">        Draw x axis?</span>
<span class="sd">    yaxis : bool, default `xyaxes`</span>
<span class="sd">        Draw y axis?</span>
<span class="sd">    xorigin : float, default None</span>
<span class="sd">        Horizontal position of y axis in data coordinates. A reasonable value</span>
<span class="sd">        could be zero. By default, the y axis is shown on the left.</span>
<span class="sd">    yorigin : float, default None</span>
<span class="sd">        Vertical position of x axis in data coordinates. A reasonable value</span>
<span class="sd">        could be zero. By default, the x axis is shown on the bottom.</span>
<span class="sd">    frame : bool, default `xyaxes`</span>
<span class="sd">        Draw frame around plot area?</span>
<span class="sd">    grid : bool, default False</span>
<span class="sd">        Add grid lines at tick positions?</span>
<span class="sd">    minorgrid : bool, default False</span>
<span class="sd">        Add grid lines at minor-tick positions?</span>
<span class="sd">    colorbar : bool or str, default None</span>
<span class="sd">        Draw colorbar? If ``None``, the colorbar is drawn if any line is given a</span>
<span class="sd">        z value or if both `zmin` and `zmax` are given. Alternatively, the path</span>
<span class="sd">        to an image with a color gradient can be specified. Here, an image width</span>
<span class="sd">        of one pixel is sufficient.</span>
<span class="sd">    outline : bool, default False</span>
<span class="sd">        Draw dashed figure outline?</span>
<span class="sd">    canvas : str, default None</span>
<span class="sd">        Background color of whole document.</span>
<span class="sd">    background : str, default None</span>
<span class="sd">        Path to background image.</span>
<span class="sd">    preamble : str, default &#39;&#39;</span>
<span class="sd">        Definitions for standalone figures.</span>
<span class="sd">    inputenc : str, default None</span>
<span class="sd">        Text encoding, e.g., ``&#39;utf8&#39;``.</span>
<span class="sd">    fontenc : str, default None</span>
<span class="sd">        Font encoding. The default is ``&#39;T1&#39;`` if `font` is specified, none</span>
<span class="sd">        otherwise.</span>
<span class="sd">    font : str, default None</span>
<span class="sd">        Predefined font selection. Imitates well-known fonts. Possible values</span>
<span class="sd">        are ``&#39;Gill Sans&#39;``, ``&#39;Helvetica&#39;``, ``&#39;Iwona&#39;``, ``&#39;Latin Modern&#39;``,</span>
<span class="sd">        ``&#39;Times&#39;``, ``&#39;Utopia&#39;``, and ``&#39;Concrete&#39;``.</span>
<span class="sd">    fontsize : int, default 10</span>
<span class="sd">        Font size for standalone figures in pt.</span>
<span class="sd">    single : float, default 8.0</span>
<span class="sd">        Single-column width for the chosen `style`.</span>
<span class="sd">    double : float, default 17.0</span>
<span class="sd">        Full textwidth for the chosen `style`.</span>
<span class="sd">    resolution : float, default 1e-3</span>
<span class="sd">        Smallest distance in cm expected to be discernible when looking at the</span>
<span class="sd">        plot. The default is acceptable when the plot is viewed or printed in</span>
<span class="sd">        its original size. For zooming, smaller values may be necessary. This</span>
<span class="sd">        parameter determines the number of vertices used to render a line and</span>
<span class="sd">        thus affects the file size.</span>
<span class="sd">    eps : float, default 1e-4</span>
<span class="sd">        Distance from plot boundary in cm beyond which a mark or grid line is</span>
<span class="sd">        considered to lie outside of the plot area (and is potentially cut off).</span>
<span class="sd">        This tolerance is meant to make up for the limited numerical precision.</span>
<span class="sd">        For example, using double preicision, ``3 * 0.1 &gt; 0.3``.</span>
<span class="sd">    lines : list</span>
<span class="sd">        List of all line objects.</span>
<span class="sd">    options : dict</span>
<span class="sd">        Global TikZ options.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    In all textual attributes and parameters, numbers in angle brackets are</span>
<span class="sd">    interpreted as values in y data units, e.g., ``line_width=&#39;&lt;0.1&gt;&#39;``. For</span>
<span class="sd">    the parameters `line_width` and `mark_size` this is also the case if an</span>
<span class="sd">    integer or float is passed instead of a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">more</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">margin</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dleft</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dright</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbottom</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtop</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">margmin</span> <span class="o">=</span> <span class="mf">0.15</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;marks&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;spacing&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">smash{</span><span class="se">\\</span><span class="s1">llap</span><span class="se">\\</span><span class="s1">textminus}&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorticks&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minormarks&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorspacing&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorstep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelopt</span> <span class="o">=</span> <span class="s1">&#39;inner sep=0pt, below right&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelpos</span> <span class="o">=</span> <span class="s1">&#39;LT&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lali</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbls</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">baselineskip&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbox</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcol</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llen</span> <span class="o">=</span> <span class="s1">&#39;4mm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lopt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpos</span> <span class="o">=</span> <span class="s1">&#39;cm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lput</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ltop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lwid</span> <span class="o">=</span> <span class="mf">4.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">=</span> <span class="mf">0.07</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minortick</span> <span class="o">=</span> <span class="mf">0.04</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="o">=</span> <span class="n">xyaxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="o">=</span> <span class="n">xyaxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xorigin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yorigin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">xyaxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minorgrid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputenc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontenc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="mf">8.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="mf">17.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mark_size</span><span class="o">=</span><span class="s1">&#39;0.05cm&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rounded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">line_cap</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">line_join</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;APS&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="s1">&#39;Times&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="mf">8.6</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="mf">17.8</span>

            <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;NanoLett&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="s1">&#39;Helvetica&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="mf">3.33</span> <span class="o">*</span> <span class="n">inch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="mf">7.0</span> <span class="o">*</span> <span class="n">inch</span>

            <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;NatCommun&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="s1">&#39;Helvetica&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelsize</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textbf{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="mf">8.8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="mf">18.0</span>

            <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;Nature&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="s1">&#39;Helvetica&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">7</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelsize</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textbf{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="mf">8.9</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="mf">18.3</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">more</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Plot.line">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.line">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

            <span class="n">axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cut</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">frame</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">join</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">jump</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">miter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">nib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">omit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">protrusion</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sgn</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">shortcut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">shortcut_rel</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">thickness</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">xref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">zindex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

            <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add line/curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, y : list or float</span>
<span class="sd">            Coordinates of data points.</span>
<span class="sd">        z : float, default None</span>
<span class="sd">            z value for entire line, represented by color.</span>
<span class="sd">        axes : bool, default False</span>
<span class="sd">            Draw axes at current z index? By default, the axes are drawn first,</span>
<span class="sd">            i.e., below all data.</span>
<span class="sd">        code : str, default None</span>
<span class="sd">            Literal TikZ code to be inserted at current position.</span>
<span class="sd">        cut : bool or tuple, default False</span>
<span class="sd">            Cut off line segments beyond plotting range? It is also possible to</span>
<span class="sd">            pass the clipping window as a tuple ``(xmin, xmax, ymin, ymax)`` in</span>
<span class="sd">            data coordinates, where ``None`` is replaced by the plot bounds.</span>
<span class="sd">        frame : bool, default False</span>
<span class="sd">            Draw frame at current z index? By default, the frame is drawn just</span>
<span class="sd">            below the axes.</span>
<span class="sd">        grid : bool, default False</span>
<span class="sd">            Add grid lines (at positions of major and possibly minor ticks) at</span>
<span class="sd">            current z index? By default, the grid is drawn just below the frame.</span>
<span class="sd">        join : bool, default None</span>
<span class="sd">            Join cut-up line segments along edge of plotting range? By default,</span>
<span class="sd">            this is ``True`` if any ``fill`` is specified, ``False`` otherwise.</span>
<span class="sd">        jump : float, default 0</span>
<span class="sd">            Shortest distance between consecutive data points that is</span>
<span class="sd">            considered as a discontinuity.</span>
<span class="sd">        label : str, default None</span>
<span class="sd">            Label for legend entry. The special label ``*next*`` adds a second</span>
<span class="sd">            example line with the current line style to the next legend entry.</span>
<span class="sd">            ``*none*`` adds an empty legend entry, i.e., some whitespace.</span>
<span class="sd">        miter : bool, default False</span>
<span class="sd">            Draw fatbands using `miter_butt` function? If ``False``, the</span>
<span class="sd">            `fatband` function is used.</span>
<span class="sd">        nib : float, default None</span>
<span class="sd">            Angle of broad pen nib. If ``None``, the nib is held perpendicular</span>
<span class="sd">            to the direction of the current line segment.</span>
<span class="sd">        omit : bool, default None</span>
<span class="sd">            Remove irrelevant vertices of linear spline? The default is</span>
<span class="sd">            ``False`` if the TikZ option ``mark`` is set, ``True`` otherwise.</span>
<span class="sd">        protrusion : float, default 0</span>
<span class="sd">            Extend curve linearly at both ends? This may improve the appearance</span>
<span class="sd">            of fatbands ending at the edge of the plotting range.</span>
<span class="sd">        sgn : integer, default +1</span>
<span class="sd">            Direction of fatband outline. Coinciding outlines should be drawn</span>
<span class="sd">            in the same direction if `omit` is ``True``.</span>
<span class="sd">        shifts : list of float</span>
<span class="sd">            Displacements in weight direction of fatband.</span>
<span class="sd">        shortcut : float, default 0</span>
<span class="sd">            Maximum length of loop to be cut off.</span>
<span class="sd">        shortcut_rel : float, default 0.5</span>
<span class="sd">            Maximum length of loop to be cut off relative to the total length</span>
<span class="sd">            of the curve. This is only used if `shortcut` is nonzero.</span>
<span class="sd">        thickness : float, default 0.05</span>
<span class="sd">           Fatband linewidth in cm.</span>
<span class="sd">        weights : list of float</span>
<span class="sd">            Fatband weights.</span>
<span class="sd">        xref, yref : float, default None</span>
<span class="sd">            Reference values for filled curves. This is useful to visualize</span>
<span class="sd">            integrands such as a density of states.</span>
<span class="sd">        zindex : int, default None</span>
<span class="sd">            Index of list of lines where new line is inserted. By default, the</span>
<span class="sd">            new line is appended to the list, i.e., has the highest `zindex`.</span>
<span class="sd">        **options</span>
<span class="sd">            Local TikZ options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span>

        <span class="n">new_line</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>

            <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">join</span><span class="o">=</span><span class="n">join</span><span class="p">,</span>
            <span class="n">jump</span><span class="o">=</span><span class="n">jump</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">miter</span><span class="o">=</span><span class="n">miter</span><span class="p">,</span>
            <span class="n">nib</span><span class="o">=</span><span class="n">nib</span><span class="p">,</span>
            <span class="n">omit</span><span class="o">=</span><span class="n">omit</span><span class="p">,</span>
            <span class="n">protrusion</span><span class="o">=</span><span class="n">protrusion</span><span class="p">,</span>
            <span class="n">sgn</span><span class="o">=</span><span class="n">sgn</span><span class="p">,</span>
            <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span>
            <span class="n">shortcut</span><span class="o">=</span><span class="n">shortcut</span><span class="p">,</span>
            <span class="n">shortcut_rel</span><span class="o">=</span><span class="n">shortcut_rel</span><span class="p">,</span>
            <span class="n">thickness</span><span class="o">=</span><span class="n">thickness</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">xref</span><span class="o">=</span><span class="n">xref</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="n">yref</span><span class="p">,</span>

            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">zindex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">zindex</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plot.fatband">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.fatband">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fatband</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw fatband.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, y : list</span>
<span class="sd">            Vertices of linear spline.</span>
<span class="sd">        weights : list of float or float, default 1.0</span>
<span class="sd">            Weights of `x` and `y`.</span>
<span class="sd">        shifts : list of float or float, default 0.0</span>
<span class="sd">            Displacements in weight direction.</span>
<span class="sd">        fill, draw : str or Color</span>
<span class="sd">            TikZ line options (filled without outline by default).</span>
<span class="sd">        **options</span>
<span class="sd">            Options passed to `line` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">weights</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="n">shifts</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">island</span> <span class="ow">in</span> <span class="n">islands</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])):</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">island</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">island</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">island</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plot.compline">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.compline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represent points of multiple weights as composite fatband.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, y : list of float</span>
<span class="sd">            Coordinates of line vertices.</span>
<span class="sd">        weights : list of tuple of float, list of float, or float, default 1.0</span>
<span class="sd">            Weights of vertices. The corresponding linewidth is always measured</span>
<span class="sd">            perpendicular to the direction of the line; This ensures that lines</span>
<span class="sd">            of the same weight have the same thickness regardless of direction.</span>
<span class="sd">        colors : list of str or str, default True</span>
<span class="sd">            Colors of different components. Any objects whose representations</span>
<span class="sd">            as a string are valid LaTeX colors can be used. If ``True``, the</span>
<span class="sd">            fill color is the same as the stroke color.</span>
<span class="sd">        threshold : float, default 0.0</span>
<span class="sd">            Minimum displayed weight.</span>
<span class="sd">        **options</span>
<span class="sd">            Further line options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">part</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">part</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">part</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">weights</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">weights</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">colors</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">shifts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
            <span class="n">shifts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="n">shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">part</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="n">shift</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">shift</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">part</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">sgn</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">weights</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">shifts</span><span class="p">),</span> <span class="n">colors</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fatband</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">sgn</span><span class="o">=</span><span class="n">sgn</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="n">sgn</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="Plot.node">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw (text) node at given position.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, y : float</span>
<span class="sd">            Node position in data coordinates.</span>
<span class="sd">        content : str</span>
<span class="sd">            Node content.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name/label to refer back to the node.</span>
<span class="sd">        **options</span>
<span class="sd">            TikZ options of the node, e.g., ``above left=True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">node</span><span class="si">%s%s</span><span class="s1"> at (&lt;x=</span><span class="si">%.14g</span><span class="s1">&gt;, &lt;y=</span><span class="si">%.14g</span><span class="s1">&gt;) {</span><span class="si">%s</span><span class="s1">};&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">csv</span><span class="p">(</span><span class="n">options</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span></div>


<div class="viewcode-block" id="Plot.cut">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Indicate broken axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, y : float</span>
<span class="sd">            Position of the break symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">, xshift=&lt;x=</span><span class="si">%.14g</span><span class="s1">&gt;cm, yshift=&lt;y=</span><span class="si">%.14g</span><span class="s1">&gt;cm] &#39;</span>
                <span class="s1">&#39;(-0.1, -0.15) -- (0.1, 0.05) </span><span class="si">%s</span><span class="s1"> (0.1, 0.15) -- (-0.1, -0.05);&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">to</span><span class="p">))</span></div>


<div class="viewcode-block" id="Plot.point">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.point">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, y : float</span>
<span class="sd">            Point position in data coordinates.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name/label to refer back to the point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">coordinate (</span><span class="si">%s</span><span class="s1">) at (&lt;x=</span><span class="si">%.14g</span><span class="s1">&gt;, &lt;y=</span><span class="si">%.14g</span><span class="s1">&gt;);&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>


<div class="viewcode-block" id="Plot.image">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert image between given data coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            File name of image.</span>
<span class="sd">        x1, y1 : float</span>
<span class="sd">            Position of bottom-left corner in data coordinates.</span>
<span class="sd">        x2, y2 : float</span>
<span class="sd">            Position of top-right corner in data coordinates.</span>
<span class="sd">        **options</span>
<span class="sd">            Options passed to `line`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">:</span>
            <span class="n">xscale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xscale</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x1</span>

        <span class="k">if</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">:</span>
            <span class="n">yscale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yscale</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y1</span>

        <span class="n">graphics</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">includegraphics[width=&lt;dx=</span><span class="si">%g</span><span class="s1">&gt;cm, height=&lt;dy=</span><span class="si">%g</span><span class="s1">&gt;cm]{</span><span class="si">%s</span><span class="s1">}&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">xscale</span> <span class="o">==</span> <span class="n">yscale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">graphics</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">scalebox{</span><span class="si">%s</span><span class="s1">}[</span><span class="si">%s</span><span class="s1">]{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">graphics</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">node at (&lt;x=</span><span class="si">%g</span><span class="s1">&gt;, &lt;y=</span><span class="si">%g</span><span class="s1">&gt;) &#39;</span>
            <span class="s1">&#39;[anchor=south west, inner sep=0, outer sep=0] {</span><span class="si">%s</span><span class="s1">};&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">graphics</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plot.code">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.code">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert literal TikZ code.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str</span>
<span class="sd">            TikZ code. Positions and distances in data coordinates and units</span>
<span class="sd">            can be specified using angle brackets, e.g., ``(&lt;x=1&gt;, &lt;y=2&gt;)`` or</span>
<span class="sd">            ``+(&lt;dx=1&gt;, &lt;dy=2&gt;)``.</span>
<span class="sd">        **options</span>
<span class="sd">            Options passed to `line`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plot.axes">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.axes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw axes at current z index.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plot.nolabel">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.nolabel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nolabel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass empty entry to legend (as spacer between entries).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">draw</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plot.clear">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.clear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all lines from plot.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Plot.save">
<a class="viewcode-back" href="../../modules/plot.html#storylines.plot.Plot.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">external</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standalone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pdf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">png</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pdflatex&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save plot to file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            File name. If no period is contained, the ``.tex`` extension</span>
<span class="sd">            may be omitted.</span>
<span class="sd">        external : bool, default False</span>
<span class="sd">            Provide file name to TikZ library ``external``.</span>
<span class="sd">        standalone : bool, default False</span>
<span class="sd">            Create file that can be typeset with ``pdflatex``, i.e., include</span>
<span class="sd">            document header etc.?</span>
<span class="sd">        pdf : bool, default False</span>
<span class="sd">            Typeset TeX file via ``pdflatex``? This implies `standalone`.</span>
<span class="sd">            Automatically set to ``True`` if `filename` ends with ``.pdf``.</span>
<span class="sd">        png : bool, default False</span>
<span class="sd">            Rasterize PDF file via ``pdftoppm``? This implies `pdf`.</span>
<span class="sd">            Automatically set to ``True`` if `filename` ends with ``.png``.</span>
<span class="sd">        dpi : float, default 300.0</span>
<span class="sd">            Image resolution in dots per inch.</span>
<span class="sd">        width, height : int</span>
<span class="sd">            Image dimensions in pixels. If either `width` or `height` is zero,</span>
<span class="sd">            it will be determined by the aspect ratio of the image. If both are</span>
<span class="sd">            zero, they will also be determined by `dpi`.</span>
<span class="sd">        rewrite : bool, default False</span>
<span class="sd">            Rewrite resulting PNG file using StoryLines? This will remove</span>
<span class="sd">            possible metadata and may reduce the file size but currently is</span>
<span class="sd">            quite slow.</span>
<span class="sd">        engine : str, default &#39;pdflatex&#39;</span>
<span class="sd">            TeX typesetting engine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine data limits:</span>

        <span class="n">lower</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span> <span class="o">=</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

            <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmin</span> <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">if</span> <span class="n">X</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax</span> <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">if</span> <span class="n">X</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;padding&#39;</span><span class="p">)</span>
            <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;padding&#39;</span><span class="p">)</span>

            <span class="c1"># embed zero- and one-dimensional data:</span>

            <span class="k">if</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
                <span class="n">padding</span> <span class="o">=</span> <span class="n">power_of_ten</span><span class="p">(</span><span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

                <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-=</span> <span class="n">padding</span>
                <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="n">padding</span>

        <span class="c1"># choose automatic margins:</span>

        <span class="n">baselineskip</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">*</span> <span class="n">pt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margmin</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span><span class="p">:</span>
                <span class="n">xticks</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xticks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xticks</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmarks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlabels</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlabel</span> <span class="ow">or</span> <span class="n">xticks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">+</span> <span class="n">baselineskip</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlabel</span> <span class="ow">and</span> <span class="n">xticks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xclose</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+=</span> <span class="n">baselineskip</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margmin</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span><span class="p">:</span>
                <span class="n">yticks</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">yticks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yticks</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymarks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylabels</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylabel</span> <span class="ow">or</span> <span class="n">yticks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">+</span> <span class="n">baselineskip</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylabel</span> <span class="ow">and</span> <span class="n">yticks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">yclose</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+=</span> <span class="n">baselineskip</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margmin</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span>

                <span class="n">zticks</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">zticks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zticks</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmarks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlabels</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlabel</span> <span class="ow">or</span> <span class="n">zticks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">+=</span> <span class="n">baselineskip</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlabel</span> <span class="ow">and</span> <span class="n">zticks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zclose</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">+=</span> <span class="n">baselineskip</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margmin</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+=</span> <span class="n">baselineskip</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># interpret negative as inner dimensions:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>

        <span class="c1"># temporarily subtract protrusions from margins:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dleft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dright</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtop</span>

        <span class="c1"># determine extent of the plotting area:</span>

        <span class="n">extent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span>
        <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>

        <span class="c1"># determine width or height for proportional plot:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
            <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> \
                        <span class="o">/</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
            <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> \
                        <span class="o">/</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span>

        <span class="c1"># determine scale:</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extent</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># how many centimeters correspond to one unit of the axis?</span>

            <span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="c1"># add protrusions back to margins:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dleft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dright</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtop</span>

        <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dleft</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">upper</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dright</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbottom</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">upper</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtop</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dleft</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dright</span>
        <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbottom</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtop</span>

        <span class="c1"># take care of z-axis:</span>

        <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>

        <span class="c1"># set aspect ratio by adjusting margins:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">+=</span> <span class="n">diff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span> <span class="o">*</span> <span class="n">diff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">ratio</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">+=</span> <span class="n">diff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span> <span class="o">*</span> <span class="n">diff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span>

        <span class="c1"># determine tick positions:</span>

        <span class="n">ticks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extent</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># use ticks or choose ticks with a spacing close to the given one:</span>

            <span class="n">xformat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;format&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;ticks&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">tick</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">xformat</span><span class="p">(</span><span class="n">tick</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;ticks&#39;</span><span class="p">)]]</span>

                <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">position</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="n">extent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">xformat</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">multiples</span><span class="p">(</span><span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xround_mantissa</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;spacing&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]))]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;labels&#39;</span><span class="p">):</span>
                <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">position</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

        <span class="c1"># determine minor-tick positions:</span>

        <span class="n">minorticks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minormarks&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">minorgrid</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorticks&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorstep&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorspacing&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

                        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="n">multiples</span><span class="p">(</span><span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorstep&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xround_mantissa</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorspacing&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>

                <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>

                <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">minor</span> <span class="k">for</span> <span class="n">minor</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">major</span> <span class="o">-</span> <span class="n">minor</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                        <span class="k">for</span> <span class="n">major</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">])]</span>

                <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="n">extent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">]</span>

        <span class="c1"># handle horizontal and vertical lines:</span>

        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="s1">&#39;yx&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">upper</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
                    <span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span>

                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;line_cap&#39;</span><span class="p">,</span> <span class="s1">&#39;butt&#39;</span><span class="p">)</span>

        <span class="c1"># create simple colormap from special lower and upper colors:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">Color</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">))</span>

        <span class="c1"># build LaTeX file:</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">stem</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">home</span> <span class="o">=</span> <span class="n">goto</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">png</span> <span class="o">=</span> <span class="n">png</span> <span class="ow">or</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span> <span class="ow">or</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span> <span class="ow">or</span> <span class="n">png</span>

        <span class="k">if</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="n">standalone</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tex&#39;</span> <span class="o">%</span> <span class="n">stem</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1"># print premable and open document:</span>

            <span class="k">if</span> <span class="n">standalone</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">documentclass[class=</span><span class="si">%s</span><span class="s1">, </span><span class="si">%d</span><span class="s1">pt]</span><span class="si">{standalone}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;article&#39;</span> <span class="k">if</span> <span class="mi">10</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">&lt;=</span> <span class="mi">12</span> <span class="k">else</span> <span class="s1">&#39;scrartcl&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span><span class="p">))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{tikz}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputenc</span> <span class="ow">and</span> <span class="s1">&#39;inputenc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[</span><span class="si">%s</span><span class="s1">]</span><span class="si">{inputenc}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputenc</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">texfonts</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;Gill Sans&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[math]</span><span class="si">{iwona}</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[sfdefault]</span><span class="si">{cabin}</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[italic, noplusnominus]</span><span class="si">{mathastext}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Helvetica&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{sansmathfonts}</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[scaled]</span><span class="si">{helvet}</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">let</span><span class="se">\\</span><span class="s1">familydefault</span><span class="se">\\</span><span class="s1">sfdefault</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[italic]</span><span class="si">{mathastext}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Iwona&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[math]</span><span class="si">{iwona}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Latin Modern&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{lmodern}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Times&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{newtxtext, newtxmath}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Utopia&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{fourier}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="ow">in</span> <span class="n">texfonts</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">texfonts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">])</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontenc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fontenc</span> <span class="o">=</span> <span class="s1">&#39;T1&#39;</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">==</span> <span class="s1">&#39;Concrete&#39;</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{concmath-otf}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">fontenc</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">engine</span> <span class="o">!=</span> <span class="s1">&#39;lualatex&#39;</span><span class="p">:</span>
                            <span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;xelatex&#39;</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{mathspec}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setallmainfonts{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>

                        <span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;xelatex&#39;</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontenc</span> <span class="ow">and</span> <span class="s1">&#39;fontenc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[</span><span class="si">%s</span><span class="s1">]</span><span class="si">{fontenc}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontenc</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mark&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="s1">&#39;mark&#39;</span><span class="p">]</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;ball&#39;</span><span class="p">]):</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usetikzlibrary</span><span class="si">{plotmarks}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{document}</span><span class="se">\n\\</span><span class="s1">noindent</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># set filename for externalization:</span>

            <span class="k">elif</span> <span class="n">external</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">tikzsetnextfilename{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="si">%%</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stem</span><span class="p">)</span>

            <span class="c1"># open TikZ environment:</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tikzpicture}%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">))</span>

            <span class="c1"># set bounding box:</span>

            <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) rectangle +(</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">);&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">useasboundingbox&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw</span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="n">csv</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="s1">&#39;1mm&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw</span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="n">csv</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">very_thin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dashed</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

            <span class="c1"># add background image:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node &#39;</span>
                    <span class="s1">&#39;[anchor=south west, inner sep=0, outer sep=0] &#39;</span>
                    <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">includegraphics[width=</span><span class="si">%.3f</span><span class="s1">cm, height=</span><span class="si">%.3f</span><span class="s1">cm]{</span><span class="si">%s</span><span class="s1">}};&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">))</span>

            <span class="c1"># draw coordinate system:</span>

            <span class="n">origin</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="n">xorigin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;origin&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">xorigin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">origin</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">origin</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">xorigin</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="s1">&#39;yx&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">[</span><span class="n">y</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">position</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">abs</span><span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">origin</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;minorticks&#39;</span><span class="p">):</span>
                    <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">abs</span><span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">origin</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">draw_grid</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">draw_grid</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                    <span class="n">lines</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;axis&#39;</span><span class="p">):</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minorgrid</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [lightgray!50, line cap=rect]&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]):</span>

                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, 0) -- +(0, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>

                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]):</span>

                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (0, </span><span class="si">%.3f</span><span class="s1">) -- +(</span><span class="si">%.3f</span><span class="s1">, 0)&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [lightgray, line cap=rect]&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]):</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, 0) -- +(0, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]):</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (0, </span><span class="si">%.3f</span><span class="s1">) -- +(</span><span class="si">%.3f</span><span class="s1">, 0)&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                <span class="n">draw_grid</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">draw_grid</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">draw_frame</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">draw_frame</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [gray, line cap=rect]</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">or</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;(0, 0) -- &#39;</span><span class="p">)</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%.3f</span><span class="s1">, 0) -- (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) -- (0, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                    <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xxyy&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="ow">or</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; -- (0, 0)&#39;</span><span class="p">)</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                <span class="n">draw_frame</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">draw_frame</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">draw_axes</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">draw_axes</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># paint colorbar:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dots</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">inch</span> <span class="o">*</span> <span class="n">dpi</span><span class="p">)))</span>

                        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">colorize</span><span class="p">([[</span><span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">dots</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)]</span>
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dots</span><span class="p">))],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.bar.png&#39;</span> <span class="o">%</span> <span class="n">stem</span>

                        <span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span><span class="p">,</span> <span class="n">colorbar</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node at (</span><span class="si">%.3f</span><span class="s1">, 0) &#39;</span>
                            <span class="s1">&#39;[anchor=south west, inner sep=0, outer sep=0] &#39;</span>
                            <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">includegraphics[width=</span><span class="si">%.3f</span><span class="s1">cm, height=</span><span class="si">%.3f</span><span class="s1">cm]&#39;</span>
                            <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}};&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">shade [bottom color=</span><span class="si">%s</span><span class="s1">, top color=</span><span class="si">%s</span><span class="s1">]&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">))</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, 0) rectangle (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">);&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span><span class="p">,</span>
                               <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span>
                               <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmarks</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node &#39;</span>
                                <span class="s1">&#39;[rotate=90, below] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) {</span><span class="si">%s</span><span class="s1">};&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>
                    <span class="n">draw_grid</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span>
                    <span class="n">draw_frame</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span><span class="p">:</span>
                    <span class="c1"># draw tick marks and labels:</span>

                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmarks</span> <span class="ow">and</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">xminormarks</span> <span class="ow">and</span> <span class="n">minorticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymarks</span> <span class="ow">and</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">yminormarks</span> <span class="ow">and</span> <span class="n">minorticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])):</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [line cap=butt]&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmarks</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">continue</span>

                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) -- +(0, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">))</span>

                                <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; node [below] {</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xminormarks</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) -- +(0, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">minortick</span><span class="p">))</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymarks</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">continue</span>

                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) -- +(</span><span class="si">%.3f</span><span class="s1">, 0)&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">))</span>

                                <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; node [</span><span class="si">%s</span><span class="s1">] {</span><span class="si">%s</span><span class="s1">}&#39;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span> <span class="k">if</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">else</span>
                                        <span class="s1">&#39;rotate=90, above&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">yminormarks</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">minorticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) -- +(</span><span class="si">%.3f</span><span class="s1">, 0)&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">minortick</span><span class="p">))</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                    <span class="c1"># draw coordinate axes:</span>

                    <span class="k">if</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [-&gt;, line cap=rect]</span><span class="se">\n</span><span class="s1">  &#39;</span>
                            <span class="s1">&#39;(0, </span><span class="si">%.3f</span><span class="s1">) -- +(</span><span class="si">%.3f</span><span class="s1">, 0);&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">))</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [-&gt;, line cap=rect]</span><span class="se">\n</span><span class="s1">  &#39;</span>
                            <span class="s1">&#39;(</span><span class="si">%.3f</span><span class="s1">, 0) -- +(0, </span><span class="si">%.3f</span><span class="s1">);&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw [</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">, line cap=butt]</span><span class="se">\n</span><span class="s1">  &#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span><span class="p">))</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%.3f</span><span class="s1">, 0) -- &#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">))</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;(0, 0)&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; -- (0, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">))</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                <span class="c1"># label coordinate axes:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlabel</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node [right] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node [below&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xclose</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=</span><span class="se">\\</span><span class="s1">baselineskip&#39;</span><span class="p">)</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">))</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  {</span><span class="si">%s</span><span class="s1">};&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlabel</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylabel</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node [above] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node [rotate=90, above&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">yclose</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=</span><span class="se">\\</span><span class="s1">baselineskip&#39;</span><span class="p">)</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  {</span><span class="si">%s</span><span class="s1">};&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylabel</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlabel</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node [rotate=90, below&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">ticks</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zclose</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=</span><span class="se">\\</span><span class="s1">baselineskip&#39;</span><span class="p">)</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  {</span><span class="si">%s</span><span class="s1">};&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlabel</span><span class="p">)</span>

                <span class="n">draw_axes</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">draw_axes</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">draw_axes</span><span class="p">()</span>

            <span class="c1"># plot lines:</span>

            <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%%%d</span><span class="s1">.3f, </span><span class="si">%%%d</span><span class="s1">.3f)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="mi">5</span> <span class="k">if</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">6</span><span class="p">,</span>
                <span class="mi">5</span> <span class="k">if</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">6</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>

                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">!</span><span class="si">%.1f</span><span class="s1">!</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mark&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ball&#39;</span><span class="p">:</span>
                        <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ball_color&#39;</span><span class="p">,</span>
                            <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;mark_size&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="p">),</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                        <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">cm&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="n">option</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&lt;([</span><span class="se">\\</span><span class="s1">d.]+)&gt;&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">match</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                                <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="n">option</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span>

                    <span class="k">for</span> <span class="n">previous</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">previous</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="s1">&#39;yx&#39;</span><span class="p">:</span>
                        <span class="n">xref</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;ref&#39;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">xref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                            <span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>

                            <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xref</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">xref</span><span class="p">]</span>
                            <span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">][:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

                    <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;protrusion&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                                    <span class="k">continue</span>

                            <span class="n">dx</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">dy</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">dr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
                            <span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;protrusion&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dr</span>

                            <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">rescale</span><span class="p">,</span>
                                <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">rescale</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">]:</span>
                        <span class="n">segments</span> <span class="o">=</span> <span class="n">jump</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">segments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">miter_butt</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;miter&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">fatband</span><span class="p">)(</span>
                            <span class="n">segment</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span>
                            <span class="n">line</span><span class="p">[</span><span class="s1">&#39;shifts&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;nib&#39;</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                            <span class="n">xmin</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mark&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="n">xmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">eps</span>

                        <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">eps</span>

                        <span class="n">ymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">ymin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">eps</span>

                        <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">eps</span>

                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">line</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span>

                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;only_marks&#39;</span><span class="p">):</span>
                            <span class="n">segments</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span>
                                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">segment</span>
                                <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xmax</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">ymax</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment</span>
                                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span>
                                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">cut2d</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span>
                                    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">])]</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;omit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">line</span><span class="p">[</span><span class="s1">&#39;omit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mark&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
                        <span class="n">options</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;omit&#39;</span><span class="p">]:</span>
                            <span class="n">segment</span> <span class="o">=</span> <span class="n">relevant</span><span class="p">(</span><span class="n">segment</span><span class="p">[::</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;sgn&#39;</span><span class="p">]],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mark&#39;</span><span class="p">)</span> \
                                <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;only_marks&#39;</span><span class="p">):</span>

                            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mark_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;shortcut&#39;</span><span class="p">]:</span>
                            <span class="n">segment</span> <span class="o">=</span> <span class="n">shortcut</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;shortcut&#39;</span><span class="p">],</span>
                                <span class="n">line</span><span class="p">[</span><span class="s1">&#39;shortcut_rel&#39;</span><span class="p">])</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">draw</span><span class="si">%s</span><span class="s1"> plot coordinates {&#39;</span>
                            <span class="o">%</span> <span class="n">csv</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>

                        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">)</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form</span> <span class="o">%</span> <span class="n">point</span>
                                <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">group</span><span class="p">))</span>

                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; };&#39;</span><span class="p">)</span>

                <span class="c1"># insert TikZ code with special coordinates:</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">=(.*?)&gt;&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">match</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">x</span><span class="p">])),</span>
                            <span class="n">code</span><span class="p">)</span>

                        <span class="n">code</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&lt;d</span><span class="si">%s</span><span class="s1">=(.*?)&gt;&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">match</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span>
                            <span class="n">code</span><span class="p">)</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]:</span>
                    <span class="n">draw_grid</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]:</span>
                    <span class="n">draw_frame</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]:</span>
                    <span class="n">draw_axes</span><span class="p">()</span>

            <span class="n">draw_axes</span><span class="p">()</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">position</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">positions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">L</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">),</span>
                        <span class="n">B</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>
                        <span class="n">l</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                        <span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                        <span class="n">r</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span>
                        <span class="n">t</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span>
                        <span class="n">R</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">),</span>
                        <span class="n">T</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="n">abbreviations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="s1">&#39;BT&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">abbreviation</span> <span class="ow">in</span> <span class="n">abbreviations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="n">abbreviation</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                        <span class="n">positions</span><span class="p">[</span><span class="n">char</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">char</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

                <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

            <span class="c1"># add label:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelformat</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">fontsize{</span><span class="si">%d</span><span class="s1">}{</span><span class="si">%d</span><span class="s1">}</span><span class="se">\\</span><span class="s1">selectfont </span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelsize</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelpos</span><span class="p">))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; [</span><span class="si">%s</span><span class="s1">] {</span><span class="si">%s</span><span class="s1">};&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelopt</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

            <span class="c1"># add legend:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lput</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ltop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">labels</span><span class="p">):</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node [align=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lali</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lopt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lopt</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbox</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;, draw=gray, fill=</span><span class="si">%s</span><span class="s1">, rounded corners=1pt&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="ow">or</span> <span class="s1">&#39;white&#39;</span><span class="p">))</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) {&#39;</span> <span class="o">%</span> <span class="n">position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpos</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltop</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltop</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsep</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tikzpicture}</span><span class="s1">[x=</span><span class="si">%s</span><span class="s1">, y=-</span><span class="si">%s</span><span class="s1">]&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbls</span><span class="p">))</span>

                    <span class="n">lrow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrow</span> <span class="ow">or</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcol</span>

                    <span class="n">spacer</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">for</span> <span class="n">options</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">lrow</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">lrow</span>

                        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;*next*&#39;</span><span class="p">:</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">row</span> <span class="o">-=</span> <span class="mf">0.2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;*none*&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    </span><span class="se">\\</span><span class="s1">node &#39;</span>
                                <span class="s1">&#39;[right] at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%d</span><span class="s1">) {</span><span class="si">%s</span><span class="s1">};&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">col</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lwid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

                        <span class="n">fill</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span>
                        <span class="n">draw</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;only_marks&#39;</span><span class="p">)</span>
                        <span class="n">draw</span> <span class="o">&amp;=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;draw&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span>
                        <span class="n">mark</span> <span class="o">=</span> <span class="s1">&#39;mark&#39;</span> <span class="ow">in</span> <span class="n">options</span>

                        <span class="k">if</span> <span class="n">fill</span> <span class="ow">or</span> <span class="n">draw</span> <span class="ow">or</span> <span class="n">mark</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">fill</span> <span class="ow">or</span> <span class="n">draw</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mark</span><span class="p">:</span>
                                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mark_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{2}</span><span class="s1">&#39;</span>

                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    </span><span class="se">\\</span><span class="s1">draw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">csv</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">      plot coordinates &#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
                                <span class="n">top</span> <span class="o">=</span> <span class="n">row</span> <span class="o">-</span> <span class="mf">0.1</span>
                                <span class="n">bot</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mf">0.1</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="n">mark</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
                                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">bot</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">bot</span><span class="p">]</span> <span class="o">*</span> <span class="n">mark</span> <span class="o">+</span> <span class="p">[</span><span class="n">bot</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">draw</span><span class="p">:</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="n">mark</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
                                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">*</span> <span class="n">mark</span> <span class="o">+</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">mark</span><span class="p">:</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span>
                                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>

                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%g</span><span class="s1">)&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">col</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lwid</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>

                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; };&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">draw</span> <span class="ow">or</span> <span class="n">fill</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="p">:</span>
                            <span class="n">spacer</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">spacer</span><span class="p">:</span>
                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    </span><span class="se">\\</span><span class="s1">useasboundingbox (0, 0);&#39;</span><span class="p">)</span>

                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="se">\\</span><span class="s1">end</span><span class="si">{tikzpicture}</span><span class="s1">%&#39;</span><span class="p">)</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  };&#39;</span><span class="p">)</span>

            <span class="c1"># add title:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">above</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>

                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">node</span><span class="si">%s</span><span class="s1"> at (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">) {</span><span class="si">%s</span><span class="s1">};&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="n">options</span><span class="p">),</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>

            <span class="c1"># close TikZ environment:</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end</span><span class="si">{tikzpicture}</span><span class="s1">%&#39;</span><span class="p">)</span>

            <span class="c1"># close document:</span>

            <span class="k">if</span> <span class="n">standalone</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end</span><span class="si">{document}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># typeset document and clean up:</span>

        <span class="k">if</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="n">typeset</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">png</span><span class="p">:</span>
            <span class="n">rasterize</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">rewrite</span><span class="p">)</span>

        <span class="n">home</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2026 Jan Berges.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>