<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>elphmod.ph &mdash; elphmod  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=1f476fd3" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #e7f2fa" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/elphmod.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/el.html">Electron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/ph.html">Phonon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/elph.html">Electron–phonon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/elel.html">Electron–electron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/MPI.html">MPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/bravais.html">Bravais</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/dispersion.html">Dispersion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/dos.html">DOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/diagrams.html">Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/occupations.html">Occupations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/md.html">MD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/eliashberg.html">Eliashberg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/plot.html">Plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/misc.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/models.html">Models</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pages/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pages/patches.html">Patches</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #e7f2fa" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">elphmod</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">elphmod.ph</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for elphmod.ph</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2017-2024 elphmod Developers</span>
<span class="c1"># This program is free software under the terms of the GNU GPLv3 or later.</span>

<span class="sd">&quot;&quot;&quot;Mass-spring models from Quantum ESPRESSO.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">elphmod.bravais</span>
<span class="kn">import</span> <span class="nn">elphmod.dispersion</span>
<span class="kn">import</span> <span class="nn">elphmod.misc</span>
<span class="kn">import</span> <span class="nn">elphmod.MPI</span>

<span class="n">comm</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">comm</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">info</span>

<div class="viewcode-block" id="Model">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model">[docs]</a>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Mass-spring model for the phonons.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flfrc : str</span>
<span class="sd">        File with interatomic force constants from ``q2r.x`` or common filename</span>
<span class="sd">        part (without appended/inserted q-point number) of dynamical matrices</span>
<span class="sd">        from ``ph.x``. Both the plain-text and XML format are supported.</span>
<span class="sd">    quadrupole_fmt : str</span>
<span class="sd">        File with quadrupole tensors in format suitable for ``epw.x``.</span>
<span class="sd">    apply_asr : bool</span>
<span class="sd">        Apply acoustic sum rule correction to force constants?</span>
<span class="sd">    apply_asr_simple : bool</span>
<span class="sd">        Apply simple acoustic sum rule correction to force constants? This sets</span>
<span class="sd">        the self force constant to minus the sum of all other force constants.</span>
<span class="sd">    apply_zasr : bool</span>
<span class="sd">        Apply acoustic sum rule correction to Born effective charges?</span>
<span class="sd">    apply_rsr : bool</span>
<span class="sd">        Apply rotation sum rule correction to force constants?</span>
<span class="sd">    lr : bool</span>
<span class="sd">        Compute long-range terms in case of polar material?</span>
<span class="sd">    lr2d : bool</span>
<span class="sd">        Compute long-range terms for two-dimensional system if `lr`?</span>
<span class="sd">    amass : ndarray</span>
<span class="sd">        Atomic masses if `flfrc` is omitted.</span>
<span class="sd">    at : ndarray</span>
<span class="sd">        Bravais lattice vectors if `flfrc` is omitted.</span>
<span class="sd">    tau : ndarray</span>
<span class="sd">        Positions of basis atoms if `flfrc` is omitted.</span>
<span class="sd">    atom_order : list of str</span>
<span class="sd">        Ordered list of atoms if `flfrc` is omitted.</span>
<span class="sd">    alph : float</span>
<span class="sd">        Ewald parameter if `flfrc` is omitted.</span>
<span class="sd">    epsil : ndarray</span>
<span class="sd">        Dielectric tensor if `flfrc` is omitted.</span>
<span class="sd">    zeu : ndarray</span>
<span class="sd">        Born effective charges if `flfrc` is omitted.</span>
<span class="sd">    Q : ndarray</span>
<span class="sd">        Quadrupole tensors if `quadrupole_fmt` is omitted.</span>
<span class="sd">    L : float</span>
<span class="sd">        Range-separation parameter for two-dimensional electrostatics.</span>
<span class="sd">    perp : bool</span>
<span class="sd">        Yield out-of-plane long-range terms if `L` is nonzero?</span>
<span class="sd">    divide_mass : bool</span>
<span class="sd">        Divide force constants and Born effective charges by atomic masses?</span>
<span class="sd">    divide_ndegen : bool</span>
<span class="sd">        Divide force constants by degeneracy of Wigner-Seitz point? Only</span>
<span class="sd">        ``True`` yields correct phonons. ``False`` should only be used for</span>
<span class="sd">        debugging.</span>
<span class="sd">    ifc : str</span>
<span class="sd">        Name of file with interatomic force constants to be created if `flfrc`</span>
<span class="sd">        is prefix of files with dynamical matrices. Used to emulate ``q2r.x``.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    R : ndarray</span>
<span class="sd">        Lattice vectors :math:`\vec R` of Wigner-Seitz supercell.</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Corresponding force constants divided by atomic masses in Ry\ :sup:`2`.</span>

<span class="sd">        .. math::</span>

<span class="sd">            D_{\vec R i j} = \frac{\hbar^2}{\sqrt{M_i M_j}}</span>
<span class="sd">                \frac{\partial^2 E}{\partial u_{0 i} \partial u_{\vec R j}}</span>

<span class="sd">        If not :attr:`divide_mass`, the prefactor :math:`\hbar^2 / \sqrt{M_i</span>
<span class="sd">        M_j}` is absent and the units are Ry/bohr\ :sup:`2` instead. If</span>
<span class="sd">        :attr:`lr`, this is only the short-range component of the force</span>
<span class="sd">        constants.</span>
<span class="sd">    M : ndarray</span>
<span class="sd">        Atomic masses :math:`M_i`.</span>
<span class="sd">    a : ndarray</span>
<span class="sd">        Bravais lattice vectors.</span>
<span class="sd">    r : ndarray</span>
<span class="sd">        Positions of basis atoms.</span>
<span class="sd">    l : ndarray.</span>
<span class="sd">        Bond lengths.</span>
<span class="sd">    atom_order : list of str</span>
<span class="sd">        Ordered list of atoms.</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Ewald parameter.</span>
<span class="sd">    eps : ndarray</span>
<span class="sd">        Dielectric tensor.</span>
<span class="sd">    Z : ndarray</span>
<span class="sd">        Born effective charges.</span>
<span class="sd">    z : ndarray</span>
<span class="sd">        Born effective charges divided by square root of atomic masses.</span>
<span class="sd">    Q : ndarray</span>
<span class="sd">        Quadrupole tensors.</span>
<span class="sd">    q : ndarray</span>
<span class="sd">        Quadrupole tensors divided by square root of atomic masses.</span>
<span class="sd">    L : float</span>
<span class="sd">        Range-separation parameter for two-dimensional electrostatics.</span>
<span class="sd">    perp : bool</span>
<span class="sd">        Yield out-of-plane long-range terms if `L` is nonzero?</span>
<span class="sd">    divide_mass : bool</span>
<span class="sd">        Have force constants and Born charges been divided by atomic masses?</span>
<span class="sd">    divide_ndegen : bool</span>
<span class="sd">        Have force constants been divided by degeneracy of Wigner-Seitz point?</span>
<span class="sd">    size : int</span>
<span class="sd">        Number of displacement directions/bands.</span>
<span class="sd">    nat : int</span>
<span class="sd">        Number of atoms.</span>
<span class="sd">    nq : tuple of int</span>
<span class="sd">        Shape of original q-point mesh.</span>
<span class="sd">    q0 : ndarray</span>
<span class="sd">        Original q-point mesh.</span>
<span class="sd">    D0 : ndarray</span>
<span class="sd">        Dynamical matrices on original q-point mesh.</span>
<span class="sd">    cells : list of tuple of int, optional</span>
<span class="sd">        Lattice vectors of unit cells if the model describes a supercell.</span>
<span class="sd">    N : list of tuple of int, optional</span>
<span class="sd">        Primitive vectors of supercell if the model describes a supercell.</span>
<span class="sd">    lr : bool</span>
<span class="sd">        Compute long-range terms?</span>
<span class="sd">    lr2d : bool</span>
<span class="sd">        Compute long-range terms for two-dimensional system if `lr`?</span>
<span class="sd">    b : ndarray</span>
<span class="sd">        Reciprocal primitive vectors if `lr`.</span>
<span class="sd">    prefactor : float</span>
<span class="sd">        Prefactor of long-range terms if `lr`.</span>
<span class="sd">    r_eff : float</span>
<span class="sd">        Effective thickness if `lr2d`.</span>
<span class="sd">    scale : float</span>
<span class="sd">        Relevant scaling factor if `lr`.</span>
<span class="sd">    D0_lr : ndarray</span>
<span class="sd">        Constant part of long-range correction to dynamical matrix if `lr`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Model.D">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.D">[docs]</a>
    <span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q3</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up dynamical matrix for arbitrary q point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q1, q2, q3 : float, default 0.0</span>
<span class="sd">            q point in crystal coordinates with period :math:`2 \pi`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Fourier transform of :attr:`data`, possibly plus a long-range term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">])</span>

        <span class="c1"># Sign convention in do_q2r.f90 of QE:</span>
        <span class="c1"># 231  CALL cfft3d ( phid (:,j1,j2,na1,na2), &amp;</span>
        <span class="c1"># 232       nr1,nr2,nr3, nr1,nr2,nr3, 1, 1 )</span>
        <span class="c1"># 233  phid(:,j1,j2,na1,na2) = &amp;</span>
        <span class="c1"># 234       phid(:,j1,j2,na1,na2) / DBLE(nr1*nr2*nr3)</span>
        <span class="c1"># The last argument of cfft3d is the sign (+1).</span>

        <span class="n">Dq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Rxy,R-&gt;xy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="n">Dq</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D_lr</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Dq</span></div>


<div class="viewcode-block" id="Model.D_lr">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.D_lr">[docs]</a>
    <span class="k">def</span> <span class="nf">D_lr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q3</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate long-range part of dynamical matrix.&quot;&quot;&quot;</span>

        <span class="n">Dq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D0_lr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_long_range</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">):</span>
            <span class="n">Dq</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vec</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">vec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Dq</span></div>


<div class="viewcode-block" id="Model.C">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.C">[docs]</a>
    <span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R3</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get interatomic force constants for arbitrary lattice vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        R1, R2, R3 : int, default 0</span>
<span class="sd">            Lattice vector in units of primitive vectors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Element of :attr:`data` or zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">vector_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">R3</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flfrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quadrupole_fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_asr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">apply_asr_simple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_zasr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_rsr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lr2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">epsil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zeu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">divide_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">divide_ndegen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ifc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">phid</span> <span class="o">=</span> <span class="n">nq</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">=</span> <span class="n">D0</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flfrc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">phid</span><span class="p">,</span> <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span>
                        <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span><span class="p">,</span> <span class="n">zeu</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_flfrc</span><span class="p">(</span><span class="n">flfrc</span><span class="p">)</span>

                    <span class="n">nq</span> <span class="o">=</span> <span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">apply_asr_simple</span><span class="p">:</span>
                        <span class="n">asr</span><span class="p">(</span><span class="n">phid</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">xml</span> <span class="o">=</span> <span class="n">flfrc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">xml</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">nq</span><span class="p">,</span> <span class="n">q0</span> <span class="o">=</span> <span class="n">read_q</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">0&#39;</span> <span class="o">%</span> <span class="n">flfrc</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                            <span class="n">nq</span><span class="p">,</span> <span class="n">q0</span> <span class="o">=</span> <span class="n">read_q</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">0.xml&#39;</span> <span class="o">%</span> <span class="n">flfrc</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nq</span><span class="p">,</span> <span class="n">q0</span> <span class="o">=</span> <span class="n">read_q</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">0&#39;</span> <span class="o">%</span> <span class="n">flfrc</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">iq0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q0</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">xml</span><span class="p">:</span>
                            <span class="n">fildyn</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%d%s</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">flfrc</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">iq0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">flfrc</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fildyn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flfrc</span><span class="p">,</span> <span class="n">iq0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">iq0</span><span class="p">:</span>
                            <span class="n">q</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">read_flfrc</span><span class="p">(</span><span class="n">fildyn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="p">((</span><span class="n">q</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span>
                                <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span><span class="p">,</span> <span class="n">zeu</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_flfrc</span><span class="p">(</span><span class="n">fildyn</span><span class="p">)</span>

                            <span class="n">q0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="o">*</span><span class="n">nq</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                            <span class="n">D0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="o">*</span><span class="n">nq</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">amass</span><span class="p">),</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">amass</span><span class="p">)),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">divide_mass</span><span class="p">:</span>
                            <span class="n">divide_by_mass</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">amass</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
                            <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">])</span>

                            <span class="n">i</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">nq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span> <span class="n">nq</span><span class="p">)</span>

                            <span class="n">q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>
                            <span class="n">D0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>

                    <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">q0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                    <span class="n">D0</span> <span class="o">=</span> <span class="n">D0</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">D0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>

            <span class="k">if</span> <span class="n">quadrupole_fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">read_quadrupole_fmt</span><span class="p">(</span><span class="n">quadrupole_fmt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">apply_zasr</span> <span class="ow">and</span> <span class="n">zeu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zasr</span><span class="p">(</span><span class="n">zeu</span><span class="p">)</span>

        <span class="n">phid</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">phid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nq</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q0</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">q0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D0</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">D0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">amass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">atom_order</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">alph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">epsil</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">zeu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">perp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span> <span class="o">=</span> <span class="n">divide_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divide_ndegen</span> <span class="o">=</span> <span class="n">divide_ndegen</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lr2d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lr2d</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span> <span class="o">!=</span> <span class="n">lr2d</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning: System is assumed to be </span><span class="si">%s</span><span class="s1">-dimensional!&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;two&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span> <span class="k">else</span> <span class="s1">&#39;three&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_long_range</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">phid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">short_range_model</span><span class="p">(</span>
                <span class="n">phid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sgn</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">divide_ndegen</span><span class="o">=</span><span class="n">divide_ndegen</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">divide_mass</span><span class="p">:</span>
                <span class="n">divide_by_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">D0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_short_range</span><span class="p">(</span><span class="n">flfrc</span><span class="o">=</span><span class="n">ifc</span><span class="p">,</span>
                <span class="n">apply_asr_simple</span><span class="o">=</span><span class="n">apply_asr_simple</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">apply_asr</span> <span class="ow">or</span> <span class="n">apply_rsr</span><span class="p">:</span>
            <span class="n">sum_rule_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">apply_asr</span><span class="p">,</span> <span class="n">rsr</span><span class="o">=</span><span class="n">apply_rsr</span><span class="p">)</span>

<div class="viewcode-block" id="Model.prepare_long_range">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.prepare_long_range">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_long_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G_max</span><span class="o">=</span><span class="mf">28.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare calculation of long-range terms for polar materials.</span>

<span class="sd">        The following two routines are based on ``rgd_blk`` and ``rgd_blk_epw``</span>
<span class="sd">        of Quantum ESPRESSO and the EPW code.</span>

<span class="sd">        Copyright (C) 2010-2016 S. Ponce&#39;, R. Margine, C. Verdi, F. Giustino</span>
<span class="sd">        Copyright (C) 2001-2012 Quantum ESPRESSO group</span>

<span class="sd">        Please refer to:</span>

<span class="sd">        * Phonons: Gonze et al., Phys. Rev. B 50, 13035 (1994)</span>
<span class="sd">        * Coupling: Verdi and Giustino, Phys. Rev. Lett. 115, 176401 (2015)</span>
<span class="sd">        * 2D case: Sohier, Calandra, and Mauri, Phys. Rev. B 94, 085415 (2016)</span>
<span class="sd">        * Quadrupoles: Ponce&#39; et al., Phys. Rev. Research 3, 043022 (2021)</span>
<span class="sd">        * Improved 2D phonons: Royo and Stengel, Phys. Rev. X 11, 041027 (2021)</span>
<span class="sd">        * Improved 2D coupling: Ponce&#39; et al., Phys. Rev. B 107, 155424 (2023)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        G_max : float</span>
<span class="sd">            Cutoff for reciprocal lattice vectors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">reciprocals</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>

        <span class="n">e2</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="c1"># square of electron charge in Rydberg units</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">r_eff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefactor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">e2</span> <span class="o">/</span> <span class="n">area</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefactor</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">e2</span> <span class="o">/</span> <span class="n">volume</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">G_max</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span><span class="p">:</span>
            <span class="n">nr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">m3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">G</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">m3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span><span class="p">:</span>
                        <span class="n">GeG</span> <span class="o">=</span> <span class="p">(</span><span class="n">G</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GeG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij,j&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">GeG</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">G_max</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D0_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">Dq0_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D_lr</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D0_lr</span><span class="p">[</span><span class="n">group</span><span class="p">(</span><span class="n">na1</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">na1</span><span class="p">)]</span> <span class="o">-=</span> <span class="p">(</span>
                    <span class="n">Dq0_lr</span><span class="p">[</span><span class="n">group</span><span class="p">(</span><span class="n">na1</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">na2</span><span class="p">)])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D0_lr</span><span class="p">[</span><span class="n">group</span><span class="p">(</span><span class="n">na</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">na</span><span class="p">)]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span></div>


<div class="viewcode-block" id="Model.generate_long_range">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.generate_long_range">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_long_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">perp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generate long-range terms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q : ndarray</span>
<span class="sd">            q point in reciprocal lattice units :math:`q_i \in [0, 2 \pi)`.</span>
<span class="sd">        perp : bool</span>
<span class="sd">            Yield out-of-plane terms? Defaults to attribute :attr:`perp`.</span>
<span class="sd">        eps : float</span>
<span class="sd">            Tolerance for vanishing lattice vectors.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        float</span>
<span class="sd">            Scalar prefactor.</span>
<span class="sd">        ndarray</span>
<span class="sd">            Direction-dependent term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">perp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perp</span>

        <span class="k">for</span> <span class="n">G</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">G</span> <span class="o">+</span> <span class="n">q1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span><span class="p">:</span>
                <span class="n">KeK</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">KeK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij,j&#39;</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">KeK</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span><span class="p">:</span>
                    <span class="n">KrK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij,j&#39;</span><span class="p">,</span> <span class="n">K</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_eff</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">K</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">K_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">KeK</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">K_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefactor</span> <span class="o">*</span> <span class="n">f</span> <span class="o">/</span> <span class="n">K_norm</span>
                    <span class="n">factor</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">f</span> <span class="o">/</span> <span class="n">K_norm</span> <span class="o">*</span> <span class="n">KrK</span>

                    <span class="k">if</span> <span class="n">perp</span><span class="p">:</span>
                        <span class="n">KrK_perp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_eff</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

                        <span class="n">factor_perp</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prefactor</span> <span class="o">*</span> <span class="n">f</span> <span class="o">/</span> <span class="n">K_norm</span>
                        <span class="n">factor_perp</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">f</span> <span class="o">*</span> <span class="n">K_norm</span> <span class="o">*</span> <span class="n">KrK_perp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">KeK</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span><span class="p">:</span>
                        <span class="n">factor</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">KeK</span><span class="p">)</span> <span class="o">+</span> <span class="n">KrK</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">factor</span> <span class="o">/=</span> <span class="n">KeK</span>

                <span class="n">exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

                <span class="n">dot</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dot</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dot</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">K_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">K_norm</span>

                <span class="k">yield</span> <span class="n">factor</span><span class="p">,</span> <span class="p">(</span><span class="n">dot</span> <span class="o">*</span> <span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">perp</span><span class="p">:</span>
                    <span class="n">dot_perp</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">K_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dot_perp</span> <span class="o">+=</span> <span class="n">K_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

                    <span class="k">yield</span> <span class="n">factor_perp</span><span class="p">,</span> <span class="p">(</span><span class="n">dot_perp</span> <span class="o">*</span> <span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>


<div class="viewcode-block" id="Model.sample_orig">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.sample_orig">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample dynamical matrix on original q-point mesh.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q0</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D0</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">dispersion</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.update_short_range">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.update_short_range">[docs]</a>
    <span class="k">def</span> <span class="nf">update_short_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flfrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_asr_simple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update short-range part of interatomic force constants.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flfrc : str</span>
<span class="sd">            Filename where short-range force constants are written.</span>
<span class="sd">        apply_asr_simple : bool</span>
<span class="sd">            Apply simple acoustic sum rule correction to short-range force</span>
<span class="sd">            constants?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">D0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Run &quot;sample_orig&quot; before changing Z, Q, etc.!&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="n">q2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">,</span> <span class="n">D_full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">D0</span><span class="p">,</span> <span class="n">flfrc</span><span class="o">=</span><span class="n">flfrc</span><span class="p">,</span>
                <span class="n">apply_asr_simple</span><span class="o">=</span><span class="n">apply_asr_simple</span><span class="p">,</span> <span class="n">divide_mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_long_range</span><span class="p">()</span>

        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D0</span> <span class="o">-</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">dispersion</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_lr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q0</span><span class="p">)</span>

        <span class="n">q2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">,</span> <span class="n">D_full</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">flfrc</span><span class="o">=</span><span class="n">flfrc</span><span class="p">,</span>
            <span class="n">apply_asr_simple</span><span class="o">=</span><span class="n">apply_asr_simple</span><span class="p">,</span> <span class="n">divide_mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.sum_force_constants">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.sum_force_constants">[docs]</a>
    <span class="k">def</span> <span class="nf">sum_force_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate sum of absolute values of short-range force constants.</span>

<span class="sd">        For the optimal range-separation parameter this value is minimal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C_all</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">C_all</span> <span class="o">=</span> <span class="n">C_all</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">C_self</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">C_self</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">C_self</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))))</span>

        <span class="n">cost</span> <span class="o">=</span> <span class="n">C_all</span> <span class="o">-</span> <span class="n">C_self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                <span class="n">cost</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
                <span class="n">cost</span><span class="p">[:,</span> <span class="n">na</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">cost</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">))</span></div>


<div class="viewcode-block" id="Model.supercell">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.supercell">[docs]</a>
    <span class="k">def</span> <span class="nf">supercell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">N2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">N3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map mass-spring model onto supercell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N1, N2, N3 : tuple of int or int, default 1</span>
<span class="sd">            Supercell lattice vectors in units of primitive lattice vectors.</span>
<span class="sd">        sparse : bool, default False</span>
<span class="sd">            Only calculate q = 0 dynamical matrix as a sparse matrix to save</span>
<span class="sd">            memory? The result is stored in the attribute :attr:`Ds`. Consider</span>
<span class="sd">            using :meth:`standardize` with nonzero `eps` and `symmetrize`</span>
<span class="sd">            before.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            Mass-spring model for supercell.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        elphmod.bravais.supercell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

        <span class="n">supercell</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">supercell</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span> <span class="n">N2</span><span class="p">,</span> <span class="n">N3</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">supercell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">supercell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ph</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">))</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">atom_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">nat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">n1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">na</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span> <span class="ow">in</span> <span class="n">ph</span><span class="o">.</span><span class="n">cells</span>
            <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">)])</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">divide_ndegen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_ndegen</span>

        <span class="n">ph</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">lr2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">perp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perp</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">prepare_long_range</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="n">sparse_array</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">get_sparse_array</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">ph</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
                <span class="n">ph</span><span class="o">.</span><span class="n">Ds</span> <span class="o">=</span> <span class="n">sparse_array</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">D_lr</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ph</span><span class="o">.</span><span class="n">Ds</span> <span class="o">=</span> <span class="n">sparse_array</span><span class="p">((</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">const</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">),</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;map force constants onto supercell&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">)):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)):</span>
                    <span class="n">R</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">to_supercell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">ph</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">supercell</span><span class="p">)</span>

                    <span class="n">Y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

                    <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
                        <span class="n">ph</span><span class="o">.</span><span class="n">Ds</span><span class="p">[</span><span class="n">X</span><span class="p">:</span><span class="n">X</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">Y</span><span class="p">:</span><span class="n">Y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">R</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                        <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

                    <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">][</span><span class="n">X</span><span class="p">:</span><span class="n">X</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">Y</span><span class="p">:</span><span class="n">Y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">ph</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
            <span class="n">const</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Ds</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">Ds</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ph</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ph</span></div>


<div class="viewcode-block" id="Model.unit_cell">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.unit_cell">[docs]</a>
    <span class="k">def</span> <span class="nf">unit_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map mass-spring model back to unit cell.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        supercell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">nat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[:</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">]</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">atom_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="p">[:</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">]</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">]</span>

        <span class="n">B1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">B2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">B3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B1</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">B3</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>

        <span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">divide_ndegen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_ndegen</span>

        <span class="n">ph</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">lr2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr2d</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">perp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perp</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">[:</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[:</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">prepare_long_range</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">const</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;map force constants back to unit cell&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">C</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell</span><span class="p">))</span>
                        <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span>

                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">ph</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
            <span class="n">const</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ph</span></div>


<div class="viewcode-block" id="Model.order_atoms">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.order_atoms">[docs]</a>
    <span class="k">def</span> <span class="nf">order_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reorder atoms.</span>

<span class="sd">        Together with :func:`shift_atoms`, this function helps reconcile</span>
<span class="sd">        inconsistent definitions of the basis/motif of the Bravais lattice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *order : int</span>
<span class="sd">            New atom order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">order</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">order</span><span class="p">,</span> <span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_long_range</span><span class="p">()</span></div>


<div class="viewcode-block" id="Model.shift_atoms">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.shift_atoms">[docs]</a>
    <span class="k">def</span> <span class="nf">shift_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move selected atoms across unit-cell boundary.</span>

<span class="sd">        Together with :func:`order_atoms`, this function helps reconcile</span>
<span class="sd">        inconsistent definitions of the basis/motif of the Bravais lattice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : slice</span>
<span class="sd">            Slice of atom indices corresponding to selected basis atom(s).</span>
<span class="sd">        S : tuple of int</span>
<span class="sd">            Shift of as multiple of primitive lattice vectors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span>

        <span class="n">R</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">-=</span> <span class="n">S</span>
        <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">R</span><span class="p">[</span><span class="n">m</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">S</span>
        <span class="n">data</span><span class="p">[</span><span class="n">m</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">m</span><span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">m</span><span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.standardize">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.standardize">[docs]</a>
    <span class="k">def</span> <span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">symmetrize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Standardize mass-spring data.</span>

<span class="sd">        - Keep only nonzero force-constant matrices.</span>
<span class="sd">        - Sum over repeated lattice vectors.</span>
<span class="sd">        - Sort lattice vectors.</span>
<span class="sd">        - Optionally symmetrize force constants:</span>

<span class="sd">        .. math::</span>

<span class="sd">            D_{\vec q} = D_{\vec q}^\dagger,</span>
<span class="sd">            D_{\vec R} = D_{-\vec R}^\dagger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">const</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;standardize mass-spring data&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                        <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">symmetrize</span><span class="p">:</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                            <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">symmetrize</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.symmetrize">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.symmetrize">[docs]</a>
    <span class="k">def</span> <span class="nf">symmetrize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Symmetrize dynamical matrix.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">symmetrize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.decay">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.decay">[docs]</a>
    <span class="k">def</span> <span class="nf">decay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot force constants as a function of bond length.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Bond lengths.</span>
<span class="sd">        ndarray</span>
<span class="sd">            Frobenius norm of force-constant matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="nb">ord</span><span class="o">=</span><span class="s1">&#39;fro&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">C</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="n">nonzero</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span></div>


<div class="viewcode-block" id="Model.to_pwi">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.to_pwi">[docs]</a>
    <span class="k">def</span> <span class="nf">to_pwi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save atomic positions etc. to PWscf input file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pwi : str</span>
<span class="sd">            Filename.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Keyword arguments with further parameters to be written.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">species</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

        <span class="n">alat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">pw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;ntyp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;nat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;celldm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">alat</span><span class="p">]</span>

        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;at_species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">X</span><span class="p">)]</span> <span class="o">/</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">uRy</span>
            <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">species</span><span class="p">]</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;pp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.upf&#39;</span> <span class="o">%</span> <span class="n">X</span> <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">species</span><span class="p">]</span>

        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;crystal&#39;</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">cartesian_to_crystal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;cell_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alat&#39;</span>
        <span class="n">pw</span><span class="p">[</span><span class="s1">&#39;r_cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">/</span> <span class="n">alat</span>

        <span class="n">pw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">write_pwi</span><span class="p">(</span><span class="n">pwi</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.to_flfrc">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.Model.to_flfrc">[docs]</a>
    <span class="k">def</span> <span class="nf">to_flfrc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flfrc</span><span class="p">,</span> <span class="n">nr1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nr2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nr3</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save mass-spring model to force-constants file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flfrc : str</span>
<span class="sd">            Filename.</span>
<span class="sd">        nr1, nr2, nr3 : int, optional</span>
<span class="sd">            Mesh dimensions. If not given, :attr:`nq` is assumed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nr1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nr1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nr3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nr3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">phid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">sizes</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]):</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span><span class="p">)</span>

            <span class="n">phid</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Reduce</span><span class="p">(</span><span class="n">elphmod</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">IN_PLACE</span> <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">phid</span><span class="p">,</span> <span class="n">phid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                    <span class="n">phid</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
                    <span class="n">phid</span><span class="p">[:,</span> <span class="n">na</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Writing inconsistent force-constants file!&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The long-range part has not been subtracted (lr=False).&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The dielectric properties are written nevertheless.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Consider setting the attribute Z to None to avoid this.&#39;</span><span class="p">)</span>

            <span class="n">write_flfrc</span><span class="p">(</span><span class="n">flfrc</span><span class="p">,</span> <span class="n">phid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_order</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="group">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.group">[docs]</a>
<span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create slice of dynamical matrix belonging to `n`-th atom.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span></div>


<div class="viewcode-block" id="divide_by_mass">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.divide_by_mass">[docs]</a>
<span class="k">def</span> <span class="nf">divide_by_mass</span><span class="p">(</span><span class="n">dyn</span><span class="p">,</span> <span class="n">amass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Divide dynamical matrices by atomic masses.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dyn : ndarray</span>
<span class="sd">        Dynamical matrices.</span>
<span class="sd">    amass : list of float</span>
<span class="sd">        Atomic masses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amass</span><span class="p">)):</span>
        <span class="n">dyn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">group</span><span class="p">(</span><span class="n">na</span><span class="p">),</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amass</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
        <span class="n">dyn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="n">group</span><span class="p">(</span><span class="n">na</span><span class="p">)]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amass</span><span class="p">[</span><span class="n">na</span><span class="p">])</span></div>


<div class="viewcode-block" id="read_q">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.read_q">[docs]</a>
<span class="k">def</span> <span class="nf">read_q</span><span class="p">(</span><span class="n">fildyn0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read list of irreducible q points from *fildyn0*.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fildyn0</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">nq</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="n">nQ</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nq</span><span class="p">,</span> <span class="n">q</span></div>


<div class="viewcode-block" id="write_q">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.write_q">[docs]</a>
<span class="k">def</span> <span class="nf">write_q</span><span class="p">(</span><span class="n">fildyn0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nq</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write list of irreducible q points to *fildyn0*.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fildyn0</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%4d%4d%4d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nq</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%4d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">qxy</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%19.15f%19.15f%19.15f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span></div>


<div class="viewcode-block" id="fildyn_freq">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.fildyn_freq">[docs]</a>
<span class="k">def</span> <span class="nf">fildyn_freq</span><span class="p">(</span><span class="n">fildyn</span><span class="o">=</span><span class="s1">&#39;matdyn&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create *fildyn.freq* as created by Quantum ESPRESSO&#39;s ``ph.x``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fildyn : str, default &#39;matdyn&#39;</span>
<span class="sd">        Prefix of files with dynamical matrices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">nq</span><span class="p">,</span> <span class="n">q0</span> <span class="o">=</span> <span class="n">read_q</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">0&#39;</span> <span class="o">%</span> <span class="n">fildyn</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.freq&#39;</span> <span class="o">%</span> <span class="n">fildyn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">freq</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q0</span><span class="p">)):</span>
            <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span> <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span><span class="p">,</span> <span class="n">zeu</span> <span class="o">=</span> <span class="n">read_flfrc</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fildyn</span><span class="p">,</span> <span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">divide_by_mass</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">amass</span><span class="p">)</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">sgnsqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">w</span> <span class="o">*=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">Ry</span> <span class="o">/</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">cmm1</span>

            <span class="k">if</span> <span class="n">iq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">freq</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp;plot nbnd=</span><span class="si">%4d</span><span class="s1">, nks=</span><span class="si">%4d</span><span class="s1"> /</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">q0</span><span class="p">)))</span>

            <span class="n">freq</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%20.6f</span><span class="s1"> </span><span class="si">%9.6f</span><span class="s1"> </span><span class="si">%9.6f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">q0</span><span class="p">[</span><span class="n">iq</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">nu</span><span class="p">,</span> <span class="n">wnu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">freq</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%9.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">wnu</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span> <span class="o">%</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">nu</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                    <span class="n">freq</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_flfrc">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.read_flfrc">[docs]</a>
<span class="k">def</span> <span class="nf">read_flfrc</span><span class="p">(</span><span class="n">flfrc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read force constants in real or reciprocal space.</span>

<span class="sd">    `flfrc` can be either the force-constants file generated by ``q2r.x`` or one</span>
<span class="sd">    of the dynamical-matrix files generated by ``ph.x``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray or tuple of list of ndarray</span>
<span class="sd">        Force constants for input generated by ``q2r.x`` or equivalent q points</span>
<span class="sd">        and corresponding dynamical matrices for input generated by ``ph.x``.</span>
<span class="sd">    ndarray</span>
<span class="sd">        Atomic masses.</span>
<span class="sd">    ndarray</span>
<span class="sd">        Bravais lattice vectors.</span>
<span class="sd">    ndarray</span>
<span class="sd">        Atomic positions/basis vectors.</span>
<span class="sd">    list of str</span>
<span class="sd">        Atomic symbols.</span>
<span class="sd">    float</span>
<span class="sd">        Ewald parameter.</span>
<span class="sd">    ndarray</span>
<span class="sd">        Dielectric tensor.</span>
<span class="sd">    ndarray</span>
<span class="sd">        Born effective charges.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    write_flfrc : Inverse function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flfrc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">read_flfrc_xml</span><span class="p">(</span><span class="n">flfrc</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flfrc</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="c1"># read all words of current line:</span>

        <span class="k">def</span> <span class="nf">cells</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">words</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">words</span>

        <span class="c1"># read table:</span>

        <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">cells</span><span class="p">()))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">)])</span>

        <span class="c1"># detect file type:</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">cells</span><span class="p">()</span>

        <span class="n">dyn</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Dynamical&#39;</span>

        <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># skip title</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">cells</span><span class="p">()</span>

        <span class="c1"># read crystal structure:</span>

        <span class="n">ntyp</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">ibrav</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">celldm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>

        <span class="c1"># see Modules/latgen.f90 of Quantum ESPRESSO:</span>

        <span class="k">if</span> <span class="n">ibrav</span><span class="p">:</span>
            <span class="n">at</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">primitives</span><span class="p">(</span><span class="n">ibrav</span><span class="p">,</span> <span class="n">celldm</span><span class="o">=</span><span class="n">celldm</span><span class="p">,</span> <span class="n">bohr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># free</span>
            <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># skip &quot;Basis vectors&quot;</span>

            <span class="n">at</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">celldm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># read palette of atomic species and masses:</span>

        <span class="n">atm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntyp</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntyp</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">cells</span><span class="p">()</span>

            <span class="n">atm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">amass</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># read types and positions of individual atoms:</span>

        <span class="n">ityp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">cells</span><span class="p">()</span>

            <span class="n">ityp</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">tau</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span>

        <span class="n">tau</span> <span class="o">*=</span> <span class="n">celldm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">amass</span> <span class="o">=</span> <span class="n">amass</span><span class="p">[</span><span class="n">ityp</span><span class="p">]</span>

        <span class="n">atom_order</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">ityp</span><span class="p">:</span>
            <span class="n">atom_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atm</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="n">alph</span> <span class="o">=</span> <span class="n">epsil</span> <span class="o">=</span> <span class="n">zeu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="c1"># read sections of dynamical-matrix file:</span>

            <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cells</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;dynamical matrix in cartesian axes&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">cells</span><span class="p">()[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])))</span>
                        <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">celldm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span> <span class="o">*</span> <span class="n">nat</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">nat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                            <span class="n">cells</span><span class="p">()</span> <span class="c1"># skip line with na1, na2</span>

                            <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                                <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">cells</span><span class="p">()))</span>

                                <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                                    <span class="n">D</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">group</span><span class="p">(</span><span class="n">na1</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">na2</span><span class="p">)][</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">]</span> \
                                        <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">[</span><span class="n">group</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>

                <span class="k">elif</span> <span class="s1">&#39;dielectric tensor&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">epsil</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

                <span class="k">elif</span> <span class="s1">&#39;effective charges e-u&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">zeu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                        <span class="n">na</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cells</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">zeu</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># read macroscopic dielectric function and effective charges:</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">cells</span><span class="p">()</span>

            <span class="n">lrigid</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span>

            <span class="k">if</span> <span class="n">lrigid</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">alph</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">epsil</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

                <span class="n">zeu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                    <span class="n">na</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cells</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">zeu</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># read interatomic force constants:</span>

            <span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">cells</span><span class="p">())</span>

            <span class="n">phid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                            <span class="n">cells</span><span class="p">()</span> <span class="c1"># skip line with j1, j2, na1, na2</span>

                            <span class="k">for</span> <span class="n">m3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr3</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr2</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr1</span><span class="p">):</span>
                                        <span class="n">phid</span><span class="p">[</span><span class="n">na1</span><span class="p">,</span> <span class="n">na2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">]</span> \
                                            <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cells</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># return force constants, masses, and geometry:</span>

    <span class="k">return</span> <span class="p">[(</span><span class="n">q</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="k">if</span> <span class="n">dyn</span> <span class="k">else</span> <span class="n">phid</span><span class="p">,</span>
        <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span> <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span><span class="p">,</span> <span class="n">zeu</span><span class="p">]</span></div>


<div class="viewcode-block" id="write_flfrc">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.write_flfrc">[docs]</a>
<span class="k">def</span> <span class="nf">write_flfrc</span><span class="p">(</span><span class="n">flfrc</span><span class="p">,</span> <span class="n">phid</span><span class="p">,</span> <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span>
        <span class="n">alph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zeu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write force constants in real or reciprocal space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flfrc : str</span>
<span class="sd">        Filename.</span>
<span class="sd">    phid : ndarray or tuple of list of ndarray</span>
<span class="sd">        Force constants or equivalent q points and corresponding dynamical</span>
<span class="sd">        matrices.</span>
<span class="sd">    amass : ndarray</span>
<span class="sd">        Atomic masses.</span>
<span class="sd">    at : ndarray</span>
<span class="sd">        Bravais lattice vectors.</span>
<span class="sd">    tau : ndarray</span>
<span class="sd">        Atomic positions/basis vectors.</span>
<span class="sd">    atom_order : list of str</span>
<span class="sd">        Atomic symbols.</span>
<span class="sd">    alph : float</span>
<span class="sd">        Ewald parameter.</span>
<span class="sd">    epsil : ndarray</span>
<span class="sd">        Dielectric tensor.</span>
<span class="sd">    zeu : ndarray</span>
<span class="sd">        Born effective charges.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    read_flfrc : Inverse function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dyn</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phid</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

    <span class="n">atm</span><span class="p">,</span> <span class="n">amass</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">atom_order</span><span class="p">,</span> <span class="n">amass</span><span class="p">)),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">atom_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flfrc</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Dynamical matrix file</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write crystal structure:</span>

        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%3d</span><span class="s1"> </span><span class="si">%4d</span><span class="s1"> </span><span class="si">%2d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_order</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">alat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">celldm</span> <span class="ow">in</span> <span class="n">alat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.7f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">celldm</span><span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Basis vectors</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%14.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">/</span> <span class="n">alat</span><span class="p">))</span>

            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write palette of atomic species and masses:</span>

        <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atm</span><span class="p">)):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%12d</span><span class="s2">  &#39;</span><span class="si">%-3s</span><span class="s2">&#39; </span><span class="si">%19.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atm</span><span class="p">[</span><span class="n">nt</span><span class="p">],</span> <span class="n">amass</span><span class="p">[</span><span class="n">nt</span><span class="p">]))</span>

        <span class="c1"># write types and positions of individual atoms:</span>

        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%5d</span><span class="s1"> </span><span class="si">%4d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">na</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_order</span><span class="p">[</span><span class="n">na</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%17.10f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">/</span> <span class="n">alat</span><span class="p">))</span>

            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">phid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">alat</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># write dynamical matrices:</span>

            <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">     Dynamical matrix in Cartesian axes</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">     q = ( &#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%14.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">coordinate</span><span class="p">)</span>

                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; )</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atom_order</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atom_order</span><span class="p">)):</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%5d%5d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">na1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%12.8f%12.8f</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">group</span><span class="p">(</span><span class="n">na1</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">na2</span><span class="p">)][</span><span class="n">j</span><span class="p">]))</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write macroscopic dielectric function and effective charges:</span>

        <span class="n">lrigid</span> <span class="o">=</span> <span class="n">epsil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zeu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%2s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span> <span class="k">if</span> <span class="n">lrigid</span> <span class="k">else</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">lrigid</span> <span class="ow">and</span> <span class="n">alph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alph</span><span class="p">)</span>

            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lrigid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">     Dielectric tensor</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%23.12f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">epsil</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">     Effective charges</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zeu</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">dyn</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;     atom #&#39;</span><span class="p">)</span>

                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%5d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">na</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%14.7f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zeu</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

                    <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dyn</span><span class="p">:</span>
            <span class="c1"># write interatomic force constants:</span>

            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%4d</span><span class="s1"> </span><span class="si">%3d</span><span class="s1"> </span><span class="si">%3d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">6</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%4d</span><span class="s1"> </span><span class="si">%3d</span><span class="s1"> </span><span class="si">%3d</span><span class="s1"> </span><span class="si">%3d</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                            <span class="k">for</span> <span class="n">m3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                                <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                                    <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%4d</span><span class="s1"> </span><span class="si">%3d</span><span class="s1"> </span><span class="si">%3d</span><span class="s1"> </span><span class="si">%19.11E</span><span class="se">\n</span><span class="s1">&#39;</span>
                                            <span class="o">%</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phid</span>
                                                <span class="p">[</span><span class="n">na1</span><span class="p">,</span> <span class="n">na2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">]))</span></div>


<div class="viewcode-block" id="read_flfrc_xml">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.read_flfrc_xml">[docs]</a>
<span class="k">def</span> <span class="nf">read_flfrc_xml</span><span class="p">(</span><span class="n">flfrc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read force constants in real or reciprocal space from XML files.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    read_flfrc : Equivalent function for non-XML files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">flfrc</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flfrc</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="c1"># handle QE 7.2 XML issue (https://gitlab.com/QEF/q-e/-/issues/582):</span>

            <span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/root&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;/Root&gt;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">xml</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&lt;/Root&gt;&#39;</span><span class="p">):</span>
                <span class="n">xml</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/Root&gt;&#39;</span>

            <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

    <span class="n">geometry</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;GEOMETRY_INFO&#39;</span><span class="p">)</span>

    <span class="n">ntyp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;NUMBER_OF_TYPES&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;NUMBER_OF_ATOMS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">ibrav</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;BRAVAIS_LATTICE_INDEX&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">celldm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;CELL_DIMENSIONS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">ibrav</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">primitives</span><span class="p">(</span><span class="n">ibrav</span><span class="p">,</span> <span class="n">celldm</span><span class="o">=</span><span class="n">celldm</span><span class="p">,</span> <span class="n">bohr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;AT&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">celldm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">atm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntyp</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntyp</span><span class="p">):</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;TYPE_NAME.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">amass</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MASS.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">ityp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ATOM.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">na</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">ityp</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;INDEX&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">tau</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;TAU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

    <span class="n">tau</span> <span class="o">*=</span> <span class="n">celldm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">amass</span> <span class="o">=</span> <span class="n">amass</span><span class="p">[</span><span class="n">ityp</span><span class="p">]</span> <span class="o">*</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">uRy</span>

    <span class="n">atom_order</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">ityp</span><span class="p">:</span>
        <span class="n">atom_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atm</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

    <span class="n">dielect</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;DIELECTRIC_PROPERTIES&#39;</span><span class="p">)</span>

    <span class="n">epsil</span> <span class="o">=</span> <span class="n">dielect</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;EPSILON&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">epsil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">epsil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">epsil</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">zeu</span> <span class="o">=</span> <span class="n">dielect</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ZSTAR&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zeu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zeu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">zeu</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Z_AT_.</span><span class="si">%d</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">na</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)],</span> <span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">ifc</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;INTERATOMIC_FORCE_CONSTANTS&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ifc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alph</span> <span class="o">=</span> <span class="n">ifc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;alpha_ewald&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">alph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alph</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alph</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ifc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MESH_NQ1_NQ2_NQ3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="n">phid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">m3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr2</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr1</span><span class="p">):</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">ifc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;s_s1_m1_m2_m3.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">na1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;IFC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                            <span class="n">phid</span><span class="p">[</span><span class="n">na1</span><span class="p">,</span> <span class="n">na2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;NUMBER_OF_Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">nat</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">nat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
            <span class="n">dynmat</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;DYNAMICAL_MAT_.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">dynmat</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Q_POINT&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
            <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">celldm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">dynmat</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;PHI.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">na1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())))</span>

                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                    <span class="n">D</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">group</span><span class="p">(</span><span class="n">na1</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">na2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">phid</span> <span class="k">if</span> <span class="n">ifc</span> <span class="k">else</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span>
        <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span> <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span><span class="p">,</span> <span class="n">zeu</span><span class="p">]</span></div>


<div class="viewcode-block" id="read_quadrupole_fmt">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.read_quadrupole_fmt">[docs]</a>
<span class="k">def</span> <span class="nf">read_quadrupole_fmt</span><span class="p">(</span><span class="n">quadrupole_fmt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read file *quadrupole.fmt* suitable for ``epw.x``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    quadrupole_fmt : str</span>
<span class="sd">        Filename.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Q : ndarray</span>
<span class="sd">        Quadrupole tensor.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    write_quadrupole_fmt : Inverse function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">quadrupole_fmt</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">na</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>

            <span class="n">Qxx</span><span class="p">,</span> <span class="n">Qyy</span><span class="p">,</span> <span class="n">Qzz</span><span class="p">,</span> <span class="n">Qyz</span><span class="p">,</span> <span class="n">Qxz</span><span class="p">,</span> <span class="n">Qxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">na</span><span class="p">:</span>
                <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qxx</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qyy</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qzz</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qyz</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qyz</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qxz</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qxz</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qxy</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qxy</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_quadrupole_fmt">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.write_quadrupole_fmt">[docs]</a>
<span class="k">def</span> <span class="nf">write_quadrupole_fmt</span><span class="p">(</span><span class="n">quadrupole_fmt</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write file *quadrupole.fmt* suitable for ``epw.x``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    quadrupole_fmt : str</span>
<span class="sd">        Filename.</span>
<span class="sd">    Q : ndarray</span>
<span class="sd">        Quadrupole tensor.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    read_quadrupole_fmt : Inverse function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">quadrupole_fmt</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%4s</span><span class="s1"> </span><span class="si">%3s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="si">%14s</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;atom&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;Qxx&#39;</span><span class="p">,</span> <span class="s1">&#39;Qyy&#39;</span><span class="p">,</span> <span class="s1">&#39;Qzz&#39;</span><span class="p">,</span> <span class="s1">&#39;Qyz&#39;</span><span class="p">,</span> <span class="s1">&#39;Qxz&#39;</span><span class="p">,</span> <span class="s1">&#39;Qxy&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%4d</span><span class="s1"> </span><span class="si">%3d</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="si">%14.10f</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">na</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">Q</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="asr">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.asr">[docs]</a>
<span class="k">def</span> <span class="nf">asr</span><span class="p">(</span><span class="n">phid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply simple acoustic sum rule correction to force constants.&quot;&quot;&quot;</span>

    <span class="n">nat</span><span class="p">,</span> <span class="n">nr1</span><span class="p">,</span> <span class="n">nr2</span><span class="p">,</span> <span class="n">nr3</span> <span class="o">=</span> <span class="n">phid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">na1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
        <span class="n">phid</span><span class="p">[</span><span class="n">na1</span><span class="p">,</span> <span class="n">na1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span>
        <span class="n">phid</span><span class="p">[</span><span class="n">na1</span><span class="p">,</span> <span class="n">na2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">na2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">na1</span> <span class="o">!=</span> <span class="n">na2</span> <span class="ow">or</span> <span class="n">m1</span> <span class="ow">or</span> <span class="n">m2</span> <span class="ow">or</span> <span class="n">m3</span><span class="p">)</span></div>


<div class="viewcode-block" id="zasr">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.zasr">[docs]</a>
<span class="k">def</span> <span class="nf">zasr</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply acoustic sum rule correction to Born effective charges.&quot;&quot;&quot;</span>

    <span class="n">Z</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="sum_rule_correction">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.sum_rule_correction">[docs]</a>
<span class="k">def</span> <span class="nf">sum_rule_correction</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rsr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply sum rule correction to force constants.</span>

<span class="sd">    Unlike :func:`asr` called by the argument `apply_asr_simple`, the corrected</span>
<span class="sd">    force constants may not fulfill the point-symmetries of the crystal anymore.</span>
<span class="sd">    In turn, the total deviation from the original force constants is minimized.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ph : :class:`Model`</span>
<span class="sd">        Mass-spring model for the phonons.</span>
<span class="sd">    asr : bool</span>
<span class="sd">        Enforce acoustic sum rule?</span>
<span class="sd">    rsr : bool</span>
<span class="sd">        Enforce Born-Huang rotation sum rule?</span>
<span class="sd">    eps : float</span>
<span class="sd">        Smallest safe absolute value of divisor.</span>
<span class="sd">    report : bool</span>
<span class="sd">        Print sums before and after correction?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Sum-rule corrections do not respect point symmetries!&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Consider simple ASR correction instead (apply_asr_simple).&#39;</span><span class="p">)</span>

    <span class="c1"># define sums that should be zero:</span>

    <span class="k">def</span> <span class="nf">acoustic_sum</span><span class="p">():</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                            <span class="n">S</span> <span class="o">+=</span> <span class="n">C</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                    <span class="n">zero</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zero</span>

    <span class="k">def</span> <span class="nf">rotation_sum</span><span class="p">():</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                                <span class="n">S</span> <span class="o">+=</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                                    <span class="o">*</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">x2</span><span class="p">]))</span>
                                <span class="n">S</span> <span class="o">-=</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                                    <span class="o">*</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">x1</span><span class="p">]))</span>
                        <span class="n">zero</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zero</span>

    <span class="c1"># prepare lattice vectors and force constants:</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xy,nx-&gt;ny&#39;</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span> <span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="n">C</span><span class="p">[:,</span> <span class="n">na</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
            <span class="n">C</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

    <span class="c1"># check if sum rules are already fulfilled (before correction):</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoustic sum (before): </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">acoustic_sum</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rotation sum (before): </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rotation_sum</span><span class="p">())</span>

    <span class="c1"># determine list of constraints:</span>

    <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">asr</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                            <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">rsr</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                                <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span>
                                <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">-=</span> <span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span>

    <span class="c1"># symmetrize constraints (the force constants must be symmetric):</span>

    <span class="n">minusR</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">R</span> <span class="o">==</span> <span class="o">-</span><span class="n">ph</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">R</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">minusR</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>

    <span class="c1"># orthogonalize constraints and force constants via Gram-Schmidt method:</span>

    <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">cc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># check if sum rules are really fulfilled now (after correction):</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoustic sum (after): </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">acoustic_sum</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rotation sum (after): </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rotation_sum</span><span class="p">())</span>

    <span class="c1"># redo division by atomic masses:</span>

    <span class="k">if</span> <span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="n">C</span><span class="p">[:,</span> <span class="n">na</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
            <span class="n">C</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="sgnsqrt">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.sgnsqrt">[docs]</a>
<span class="k">def</span> <span class="nf">sgnsqrt</span><span class="p">(</span><span class="n">w2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate signed square root.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">w2</span><span class="p">))</span></div>


<div class="viewcode-block" id="polarization">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.polarization">[docs]</a>
<span class="k">def</span> <span class="nf">polarization</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Characterize as in-plane longitudinal/transverse or out-of-plane.&quot;&quot;&quot;</span>

    <span class="n">bands</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">bands</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">nat</span> <span class="o">=</span> <span class="n">bands</span> <span class="o">//</span> <span class="mi">3</span>

    <span class="n">x</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">translations</span><span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span>
    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">reciprocals</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b2</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

        <span class="n">centered</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>

        <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">/=</span> <span class="n">Q</span>

        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
            <span class="n">L</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">e</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">band</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="n">mode</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mode</span></div>


<div class="viewcode-block" id="q2r">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.q2r">[docs]</a>
<span class="k">def</span> <span class="nf">q2r</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">D_irr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q_irr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">D_full</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">apply_asr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_asr_simple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_rsr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flfrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">divide_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Interpolate dynamical matrices given for irreducible wedge of q points.</span>

<span class="sd">    This function replaces `interpolate_dynamical_matrices`, which depends on</span>
<span class="sd">    Quantum ESPRESSO. For 2D lattices, it is sufficient to provide dynamical</span>
<span class="sd">    matrices `D_irr` for the irreducible q points `q_irr`. Here, for the square</span>
<span class="sd">    lattice, the rotation symmetry (90 degrees) is currently disabled! In turn,</span>
<span class="sd">    for 1D and 2D lattices, dynamical matrices `D_full` on the complete uniform</span>
<span class="sd">    q-point mesh must be given.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ph : :class:`Model`</span>
<span class="sd">        Mass-spring model.</span>
<span class="sd">    D_irr : list of square arrays</span>
<span class="sd">        Dynamical matrices for all irreducible q points.</span>
<span class="sd">    q_irr : list of 2-tuples</span>
<span class="sd">        Irreducible q points in crystal coordinates with period :math:`2 \pi`.</span>
<span class="sd">    nq : int or tuple of int</span>
<span class="sd">        Number of q points per dimension, i.e., size of uniform mesh. Different</span>
<span class="sd">        numbers of q points along different axes can be specified via a tuple.</span>
<span class="sd">        Alternatively, `nq` is inferred from the shape of `D_full`.</span>
<span class="sd">    D_full : ndarray</span>
<span class="sd">        Dynamical matrices on complete uniform q-point mesh.</span>
<span class="sd">    angle : float</span>
<span class="sd">        Angle between mesh axes in degrees.</span>
<span class="sd">    apply_asr : bool</span>
<span class="sd">        Enforce acoustic sum rule by overwriting self force constants?</span>
<span class="sd">    apply_asr_simple : bool</span>
<span class="sd">        Apply simple acoustic sum rule correction to force constants? This sets</span>
<span class="sd">        the self force constant to minus the sum of all other force constants.</span>
<span class="sd">    apply_rsr : bool</span>
<span class="sd">        Enforce rotation sum rule by overwriting self force constants?</span>
<span class="sd">    flfrc : str</span>
<span class="sd">        Filename. If given, save file with force constants as generated by</span>
<span class="sd">        ``q2r.x``. This is done before acoustic and rotation sum are applied.</span>
<span class="sd">    divide_mass : bool</span>
<span class="sd">        Have input dynamical matrices been divided by atomic mass? This is</span>
<span class="sd">        independent of ``ph.divide_mass``, which is always respected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">D_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">D_irr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">nat</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">3</span>

        <span class="n">D_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rotation</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>  <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span>            <span class="mi">0</span><span class="p">,</span>           <span class="mi">1</span><span class="p">],</span>
                <span class="p">])</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">block</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">reflection</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk,kl-&gt;il&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>

        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">translations</span><span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span>
        <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">reciprocals</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">nq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c1"># rotation currently disabled for square lattice:</span>

        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">90</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q_irr</span><span class="p">):</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">q2</span> <span class="o">*</span> <span class="n">b2</span>

            <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">reflect</span> <span class="ow">in</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotation</span><span class="p">(</span><span class="n">phi</span><span class="p">)[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">q0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">D_irr</span><span class="p">[</span><span class="n">iq</span><span class="p">],</span> <span class="n">rotation</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">reflect</span><span class="p">:</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reflection</span><span class="p">()[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">)</span>
                        <span class="n">D</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">reflection</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">))</span>

                    <span class="c1"># only valid if atom is mapped onto image of itself:</span>

                    <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q0</span> <span class="o">-</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">)))</span>

                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                        <span class="n">D</span><span class="p">[</span><span class="n">group</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">phase</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                        <span class="n">D</span><span class="p">[:,</span> <span class="n">group</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">phase</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

                    <span class="n">Q1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>
                    <span class="n">Q2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>

                    <span class="n">D_full</span><span class="p">[</span><span class="o">+</span><span class="n">Q1</span><span class="p">,</span> <span class="o">+</span><span class="n">Q2</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
                    <span class="n">D_full</span><span class="p">[</span><span class="o">-</span><span class="n">Q1</span><span class="p">,</span> <span class="o">-</span><span class="n">Q2</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">nq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nq</span> <span class="o">=</span> <span class="n">D_full</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">nq</span> <span class="o">=</span> <span class="p">(</span><span class="n">nq</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_irr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">nq_orig</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nq</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">nq_orig</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nq_orig</span>

    <span class="n">ph</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">D_full</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ph</span><span class="o">.</span><span class="n">nat</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">3</span>

    <span class="n">D_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">D_full</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">nq</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="n">phid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">D_full</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">real</span>
    <span class="n">phid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phid</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">nq</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">phid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">phid</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">divide_mass</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
            <span class="n">phid</span><span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
            <span class="n">phid</span><span class="p">[:,</span> <span class="n">na</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">flfrc</span> <span class="ow">and</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">write_flfrc</span><span class="p">(</span><span class="n">flfrc</span><span class="p">,</span> <span class="n">phid</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">atom_order</span><span class="p">,</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">apply_asr_simple</span><span class="p">:</span>
        <span class="n">asr</span><span class="p">(</span><span class="n">phid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ph</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phid</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">phid</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>

        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sum of force constants: </span><span class="si">%g</span><span class="s1"> Ry/bohr^2 (L = </span><span class="si">%g</span><span class="s1"> bohr)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">L</span><span class="p">))</span>

    <span class="n">ph</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">short_range_model</span><span class="p">(</span><span class="n">phid</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
        <span class="n">sgn</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">divide_ndegen</span><span class="o">=</span><span class="n">ph</span><span class="o">.</span><span class="n">divide_ndegen</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
        <span class="n">divide_by_mass</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

    <span class="n">ph</span><span class="o">.</span><span class="n">nq</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">apply_asr</span> <span class="ow">or</span> <span class="n">apply_rsr</span><span class="p">:</span>
        <span class="n">sum_rule_correction</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">apply_asr</span><span class="p">,</span> <span class="n">rsr</span><span class="o">=</span><span class="n">apply_rsr</span><span class="p">)</span></div>


<div class="viewcode-block" id="interpolate_dynamical_matrices">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.interpolate_dynamical_matrices">[docs]</a>
<span class="k">def</span> <span class="nf">interpolate_dynamical_matrices</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="n">fildyn_template</span><span class="p">,</span> <span class="n">fildyn</span><span class="p">,</span> <span class="n">flfrc</span><span class="p">,</span>
        <span class="n">write_fildyn0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_asr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_asr_simple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">apply_rsr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">divide_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qe_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Interpolate dynamical matrices given for irreducible wedge of q points.</span>

<span class="sd">    This function still uses the Quantum ESPRESSO executables ``q2qstar.x`` and</span>
<span class="sd">    ``q2r.x``.  They are called in serial by each MPI process, which leads to</span>
<span class="sd">    problems if they have been compiled for parallel execution. If you want to</span>
<span class="sd">    run this function in parallel, you have two choices:</span>

<span class="sd">        (1) Configure Quantum ESPRESSO for compilation of serial executables</span>
<span class="sd">            via ``./configure --disable-parallel`` and run ``make ph``. If you</span>
<span class="sd">            do not want to make them available through the environmental</span>
<span class="sd">            variable ``PATH``, you can also set the parameter `qe-prefix` to</span>
<span class="sd">            ``&#39;/path/to/serial/q-e/bin/&#39;``.  The trailing slash is required.</span>

<span class="sd">        (2) If your MPI implementation supports nested calls to ``mpirun``, you</span>
<span class="sd">            may try to set `qe_prefix` to ``&#39;mpirun -np 1 &#39;``. The trailing</span>
<span class="sd">            space is required.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    D : list of square arrays</span>
<span class="sd">        Dynamical matrices for all irreducible q points.</span>
<span class="sd">    q : list of 2-tuples</span>
<span class="sd">        Irreducible q points in crystal coordinates with period :math:`2 \pi`.</span>
<span class="sd">    nq : int</span>
<span class="sd">        Number of q points per dimension, i.e., size of uniform mesh.</span>
<span class="sd">    fildyn_template : str</span>
<span class="sd">        Complete name of *fildyn* file from which to take header information.</span>
<span class="sd">    fildyn : str</span>
<span class="sd">        Prefix for written files with dynamical matrices.</span>
<span class="sd">    flfrc : str</span>
<span class="sd">        Name of written file with interatomic force constants.</span>
<span class="sd">    write_fildyn0 : bool</span>
<span class="sd">        Write *fildyn0* needed by ``q2r.x``? Otherwise the file must be present.</span>
<span class="sd">    apply_asr : bool</span>
<span class="sd">        Enforce acoustic sum rule by overwriting self force constants?</span>
<span class="sd">    apply_asr_simple : bool</span>
<span class="sd">        Apply simple acoustic sum rule correction to force constants? This sets</span>
<span class="sd">        the self force constant to minus the sum of all other force constants.</span>
<span class="sd">    apply_rsr : bool</span>
<span class="sd">        Enforce rotation sum rule by overwriting self force constants?</span>
<span class="sd">    divide_mass : bool</span>
<span class="sd">        Have input dynamical matrices been divided by atomic mass? This is</span>
<span class="sd">        independent of ``ph.divide_mass``, which is always respected.</span>
<span class="sd">    qe_prefix : str</span>
<span class="sd">        String to prepend to names of Quantum ESPRESSO executables.</span>
<span class="sd">    clean : bool</span>
<span class="sd">        Delete all temporary files afterwards?</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    function</span>
<span class="sd">        Fourier-interpolant (via force constants) for dynamical matrices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="c1"># read &#39;fildyn&#39; template:</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_flfrc</span><span class="p">(</span><span class="n">fildyn_template</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">atom_order</span><span class="p">,</span> <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span><span class="p">,</span> <span class="n">zeu</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># transform q points from crystal to Cartesian coordinates:</span>

    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">bravais</span><span class="o">.</span><span class="n">reciprocals</span><span class="p">(</span><span class="o">*</span><span class="n">at</span><span class="p">)</span>

    <span class="n">q_cart</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="n">q_cart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q1</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">q2</span> <span class="o">*</span> <span class="n">b2</span><span class="p">)</span>

    <span class="c1"># write &#39;fildyn0&#39; with information about q-point mesh:</span>

    <span class="k">if</span> <span class="n">write_fildyn0</span><span class="p">:</span>
        <span class="n">write_q</span><span class="p">(</span><span class="n">fildyn</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">q_cart</span><span class="p">,</span> <span class="n">nq</span><span class="p">)</span>

    <span class="c1"># write and complete &#39;fildyn1&#39;, &#39;fildyn2&#39;, ... with dynamical matrices:</span>

    <span class="k">if</span> <span class="n">divide_mass</span><span class="p">:</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amass</span><span class="p">)):</span>
            <span class="n">D</span><span class="p">[:,</span> <span class="n">group</span><span class="p">(</span><span class="n">na</span><span class="p">),</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amass</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
            <span class="n">D</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">group</span><span class="p">(</span><span class="n">na</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amass</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>

    <span class="n">sizes</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]):</span>
        <span class="n">fildynq</span> <span class="o">=</span> <span class="n">fildyn</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">Gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">q_cart</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">write_flfrc</span><span class="p">(</span><span class="n">fildynq</span><span class="p">,</span> <span class="p">(</span><span class="n">q_cart</span><span class="p">[</span><span class="n">iq</span><span class="p">:</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="n">iq</span><span class="p">:</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
            <span class="n">atom_order</span><span class="p">,</span> <span class="n">alph</span><span class="p">,</span> <span class="n">epsil</span> <span class="k">if</span> <span class="n">Gamma</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zeu</span> <span class="k">if</span> <span class="n">Gamma</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">q2qstar.x </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> &gt; /dev/null&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qe_prefix</span><span class="p">,</span> <span class="n">fildynq</span><span class="p">))</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

    <span class="c1"># compute interatomic force constants:</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;echo &quot;&amp;INPUT fildyn=&#39;</span><span class="si">{1}</span><span class="s2">&#39; flfrc=&#39;</span><span class="si">{2}</span><span class="s2">&#39; /&quot; &quot;&quot;&quot;</span>
            <span class="s1">&#39;| </span><span class="si">{0}</span><span class="s1">q2r.x &gt; /dev/null&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qe_prefix</span><span class="p">,</span> <span class="n">fildyn</span><span class="p">,</span> <span class="n">flfrc</span><span class="p">))</span>

    <span class="c1"># clean up and return mass-spring model:</span>
    <span class="c1"># (no MPI barrier needed because of broadcasting in &#39;Model&#39;)</span>

    <span class="n">ph</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">flfrc</span><span class="p">,</span> <span class="n">apply_asr</span><span class="o">=</span><span class="n">apply_asr</span><span class="p">,</span> <span class="n">apply_asr_simple</span><span class="o">=</span><span class="n">apply_asr_simple</span><span class="p">,</span>
        <span class="n">apply_rsr</span><span class="o">=</span><span class="n">apply_rsr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">0 </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fildyn</span><span class="p">,</span> <span class="n">flfrc</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fildyn</span><span class="p">,</span> <span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ph</span></div>


<div class="viewcode-block" id="spectral_function">
<a class="viewcode-back" href="../../modules/ph.html#elphmod.ph.spectral_function">[docs]</a>
<span class="k">def</span> <span class="nf">spectral_function</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate phonon spectral function.</span>

<span class="sd">    See Eq. 76 by Monacelli et al., J. Phys. Condens. Matter 33, 363001 (2021).</span>
<span class="sd">    We use an additional prefactor of 2 to normalize the frequency integral</span>
<span class="sd">    (from zero to infinity) of the phonon spectral function to the number of</span>
<span class="sd">    modes (for each q point).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    D : ndarray</span>
<span class="sd">        Dynamical matrix. The last three axes belong to the two displacement</span>
<span class="sd">        directions and the frequency argument.</span>
<span class="sd">    omega : ndarray</span>
<span class="sd">        Frequency arguments.</span>
<span class="sd">    eta : float</span>
<span class="sd">        Broadening parameter for all phonon modes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Spectral function. The first axes belongs to the frequency argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">my_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="o">*</span><span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">elphmod</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;calculate phonon spectral function&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">my_w</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])):</span>
        <span class="n">G_inv</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">eta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">my_A</span><span class="p">[</span><span class="n">my_w</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">omega</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">G_inv</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
            <span class="n">axis1</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="o">*</span><span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Allgatherv</span><span class="p">(</span><span class="n">my_A</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">my_A</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">A</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024 elphmod Developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>