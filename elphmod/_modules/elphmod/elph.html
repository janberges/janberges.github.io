<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>elphmod.elph &mdash; elphmod  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #e7f2fa" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/elphmod.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/el.html">Electron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/ph.html">Phonon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/elph.html">Electron–phonon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/elel.html">Electron–electron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/MPI.html">MPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/bravais.html">Bravais</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/dispersion.html">Dispersion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/dos.html">DOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/diagrams.html">Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/occupations.html">Occupations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/md.html">MD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/eliashberg.html">Eliashberg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/plot.html">Plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/misc.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/models.html">Models</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pages/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pages/patches.html">Patches</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #e7f2fa" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">elphmod</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">elphmod.elph</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for elphmod.elph</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2017-2024 elphmod Developers</span>
<span class="c1"># This program is free software under the terms of the GNU GPLv3 or later.</span>

<span class="c1"># Some routines in this file follow wan2bloch.f90 of EPW v5.3.1.</span>
<span class="c1"># Copyright (C) 2010-2016 S. Ponce&#39;, R. Margine, C. Verdi, F. Giustino</span>

<span class="sd">&quot;&quot;&quot;Electron-phonon coupling from EPW.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bravais</span><span class="p">,</span> <span class="n">dispersion</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">MPI</span>

<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">comm</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">info</span>

<div class="viewcode-block" id="Model">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model">[docs]</a>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Localized model for electron-phonon coupling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    epmatwp : str</span>
<span class="sd">        File with electron-phonon coupling in localized bases from EPW.</span>
<span class="sd">    wigner : str</span>
<span class="sd">        File with definition of Wigner-Seitz supercells from modified EPW.</span>
<span class="sd">    el : object</span>
<span class="sd">        Tight-binding model for the electrons.</span>
<span class="sd">    ph : object</span>
<span class="sd">        Mass-spring model for the phonons.</span>
<span class="sd">    Rk, Rg : ndarray</span>
<span class="sd">        Lattice vectors of Wigner-Seitz supercells if `wigner` is omitted.</span>
<span class="sd">    dk, dg : ndarray</span>
<span class="sd">        Degeneracies of Wigner-Seitz points if `wigner` is omitted.</span>
<span class="sd">    old_ws : bool</span>
<span class="sd">        Use previous definition of Wigner-Seitz cells? This is required if</span>
<span class="sd">        `patches/qe-6.3-backports.patch` has been used.</span>
<span class="sd">    divide_mass : bool</span>
<span class="sd">        Divide electron-phonon coupling by square root of atomic masses?</span>
<span class="sd">    divide_ndegen : bool</span>
<span class="sd">        Divide real-space coupling by degeneracy of Wigner-Seitz point? Only</span>
<span class="sd">        ``True`` yields correct couplings. ``False`` should only be used for</span>
<span class="sd">        debugging.</span>
<span class="sd">    shared_memory : bool</span>
<span class="sd">        Read coupling from EPW into shared memory?</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    el, ph : object</span>
<span class="sd">        Tight-binding and mass-spring models.</span>
<span class="sd">    Rk, Rg : ndarray</span>
<span class="sd">        Lattice vectors :math:`\vec R&#39;, \vec R` of Wigner-Seitz supercells.</span>
<span class="sd">    dk, dg : ndarray</span>
<span class="sd">        Degeneracies of Wigner-Seitz points.</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Corresponding electron-phonon matrix elements in Ry\ :sup:`3/2`.</span>

<span class="sd">        .. math::</span>

<span class="sd">            g_{\vec R i \vec R&#39; \alpha \beta} = \frac \hbar {\sqrt M_i}</span>
<span class="sd">                \bra{0 \alpha}</span>
<span class="sd">                    \frac{\partial V}{\partial u_{\vec R i}}</span>
<span class="sd">                \ket{\vec R&#39; \beta}</span>

<span class="sd">        If not :attr:`divide_mass`, the prefactor :math:`\hbar / \sqrt{M_i}` is</span>
<span class="sd">        absent and the units are Ry/bohr instead. If :attr:`ph.lr`, this is only</span>
<span class="sd">        the short-range component of the matrix elements.</span>
<span class="sd">    divide_mass : bool</span>
<span class="sd">        Has real-space coupling been divided by atomic masses?</span>
<span class="sd">    divide_ndegen : bool</span>
<span class="sd">        Has real-space coupling been divided by degeneracy of Wigner-Seitz</span>
<span class="sd">        point?</span>
<span class="sd">    node, images : MPI.Intracomm</span>
<span class="sd">        Communicators between processes that share memory or same ``node.rank``</span>
<span class="sd">        if `shared_memory`.</span>
<span class="sd">    q : ndarray</span>
<span class="sd">        Previously sampled q point, if any.</span>
<span class="sd">    gq : ndarray</span>
<span class="sd">        Rk-dependent coupling for above q point for possible reuse.</span>
<span class="sd">    cells : list of tuple of int, optional</span>
<span class="sd">        Lattice vectors of unit cells if the model describes a supercell.</span>
<span class="sd">    g0 : ndarray</span>
<span class="sd">        Coupling on original q and k meshes.</span>
<span class="sd">    Rk0 : int</span>
<span class="sd">        Index of electronic lattice vector at origin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Model.g">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.g">[docs]</a>
    <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">elbnd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">phbnd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate electron-phonon coupling for arbitary points k and k + q.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q1, q2, q2 : float, default 0.0</span>
<span class="sd">            q point in crystal coordinates with period :math:`2 \pi`.</span>
<span class="sd">        k1, k2, k3 : float, default 0.0</span>
<span class="sd">            Ingoing k point in crystal coordinates with period :math:`2 \pi`.</span>
<span class="sd">        elbnd : bool</span>
<span class="sd">            Transform to electronic band basis? Provided for convenience. Since</span>
<span class="sd">            the Hamiltonian is diagonalized on the fly for each requested matrix</span>
<span class="sd">            element, this option lacks efficiency and control of complex phases.</span>
<span class="sd">            Consider the method `sample` of this class instead.</span>
<span class="sd">        phbnd : bool</span>
<span class="sd">            Transform to phononic band basis? Provided for convenience. Since</span>
<span class="sd">            the dynamical matrix is diagonalized on the fly for each requested</span>
<span class="sd">            matrix element, this option lacks efficiency and control of complex</span>
<span class="sd">            phases. Consider the method `sample` of this class instead.</span>
<span class="sd">        broadcast : bool</span>
<span class="sd">            Broadcast result to all processors? If ``False``, returns ``None``</span>
<span class="sd">            on all but the first processor.</span>
<span class="sd">        comm : MPI communicator</span>
<span class="sd">            Group of processors running this function (for parallelization of</span>
<span class="sd">            Fourier transforms). Please note: To run this function serially,</span>
<span class="sd">            e.g., when parallelizing over q or k points, use ``elphmod.MPI.I``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Fourier transform of :attr:`data`, possibly plus a long-range term</span>
<span class="sd">            and transformed into the band basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nRq</span><span class="p">,</span> <span class="n">nph</span><span class="p">,</span> <span class="n">nRk</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">])</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">q</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>

            <span class="n">Rl</span><span class="p">,</span> <span class="n">Ru</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="n">nRq</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>

            <span class="n">my_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Rxrab,R-&gt;xrab&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">Rl</span><span class="p">:</span><span class="n">Ru</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[</span><span class="n">Rl</span><span class="p">:</span><span class="n">Ru</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>

            <span class="c1"># Sign convention in bloch2wan.f90 of EPW:</span>
            <span class="c1"># 1222  cfac = EXP(-ci * rdotk) / DBLE(nq)</span>
            <span class="c1"># 1223  epmatwp(:, :, :, :, ir) = epmatwp(:, :, :, :, ir)</span>
            <span class="c1">#           + cfac * epmatwe(:, :, :, :, iq)</span>

            <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">(</span><span class="n">my_g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gq</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
                <span class="n">g_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_lr</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gq</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rk0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">g_lr</span>

        <span class="n">Rl</span><span class="p">,</span> <span class="n">Ru</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="n">nRk</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">my_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xRab,R-&gt;xab&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gq</span><span class="p">[:,</span> <span class="n">Rl</span><span class="p">:</span><span class="n">Ru</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="n">Rl</span><span class="p">:</span><span class="n">Ru</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>

        <span class="c1"># Sign convention in bloch2wan.f90 of EPW:</span>
        <span class="c1"># 1120  cfac = EXP(-ci * rdotk) / DBLE(nkstot)</span>
        <span class="c1"># 1121  epmatw( :, :, ir) = epmatw( :, :, ir)</span>
        <span class="c1">#           + cfac * epmats(:, :, ik)</span>

        <span class="k">if</span> <span class="n">broadcast</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nph</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Reduce</span><span class="p">(</span><span class="n">my_g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Eigenvector convention in wan2bloch.f90 of EPW:</span>
            <span class="c1"># 164  cz(:, :) = chf(:, :)</span>
            <span class="c1"># 165  CALL ZHEEVD(&#39;V&#39;, &#39;L&#39;, nbnd, cz, nbnd, w, ...</span>
            <span class="c1"># ...</span>
            <span class="c1"># 278  cuf = CONJG(TRANSPOSE(cz))</span>

            <span class="c1"># Index convention in wan2bloch.f90 of EPW:</span>
            <span class="c1"># 2098  CALL ZGEMM(&#39;n&#39;, &#39;n&#39;, nbnd, nbnd, nbnd, cone, cufkq, &amp;</span>
            <span class="c1"># 2099       nbnd, epmatf(:, :, imode), nbnd, czero, eptmp, nbnd)</span>
            <span class="c1"># 2100  CALL ZGEMM(&#39;n&#39;, &#39;c&#39;, nbnd, nbnd, nbnd, cone, eptmp, &amp;</span>
            <span class="c1"># 2101       nbnd, cufkk, nbnd, czero, epmatf(:, :, imode), nbnd)</span>

            <span class="k">if</span> <span class="n">elbnd</span><span class="p">:</span>
                <span class="n">Uk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="o">*</span><span class="n">k</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Ukq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="n">q</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;am,xab,bn-&gt;xmn&#39;</span><span class="p">,</span> <span class="n">Ukq</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">g</span><span class="p">,</span> <span class="n">Uk</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">phbnd</span><span class="p">:</span>
                <span class="n">uq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">D</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xab,xu-&gt;uab&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">uq</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">broadcast</span><span class="p">:</span>
            <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="Model.g_lr">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.g_lr">[docs]</a>
    <span class="k">def</span> <span class="nf">g_lr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q3</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate long-range part of electron-phonon coupling.&quot;&quot;&quot;</span>

        <span class="n">gq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">generate_long_range</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">,</span> <span class="n">perp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">gq</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">vec</span>

        <span class="k">return</span> <span class="n">gq</span></div>


<div class="viewcode-block" id="Model.gR">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.gR">[docs]</a>
    <span class="k">def</span> <span class="nf">gR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Rq1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rq2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rq3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rk1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rk2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rk3</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get electron-phonon matrix elements for arbitrary lattice vectors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Rq1, Rq2, Rq3, Rk1, Rk2, Rk3 : int, default 0</span>
<span class="sd">            Lattice vectors in units of primitive vectors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Element of :attr:`data` or zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_q</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">vector_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">,</span> <span class="p">(</span><span class="n">Rq1</span><span class="p">,</span> <span class="n">Rq2</span><span class="p">,</span> <span class="n">Rq3</span><span class="p">))</span>
        <span class="n">index_k</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">vector_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="p">(</span><span class="n">Rk1</span><span class="p">,</span> <span class="n">Rk2</span><span class="p">,</span> <span class="n">Rk3</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">index_q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">index_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index_q</span><span class="p">,</span> <span class="p">:,</span> <span class="n">index_k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epmatwp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wigner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">el</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">Rk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Rg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">old_ws</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">divide_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">divide_ndegen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">el</span> <span class="o">=</span> <span class="n">el</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">=</span> <span class="n">ph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g0</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span> <span class="o">=</span> <span class="n">divide_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divide_ndegen</span> <span class="o">=</span> <span class="n">divide_ndegen</span>

        <span class="c1"># read lattice vectors within Wigner-Seitz cell:</span>

        <span class="k">if</span> <span class="n">wigner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Rk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Rg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span> <span class="o">=</span> <span class="n">Rk</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">Rg</span><span class="p">,</span> <span class="n">dg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">read_wigner_file</span><span class="p">(</span>
                <span class="n">wigner</span><span class="p">,</span> <span class="n">old_ws</span><span class="o">=</span><span class="n">old_ws</span><span class="p">,</span> <span class="n">nat</span><span class="o">=</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">)</span>

        <span class="c1"># read coupling in Wannier basis from EPW output:</span>
        <span class="c1"># (&#39;epmatwp&#39; allocated and printed in &#39;ephwann_shuffle.f90&#39;)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span> <span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">shared_array</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">epmatwp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">epmatwp</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mf">1e9</span><span class="p">),</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;load real-space coupling&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">irg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
                        <span class="n">count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">irg</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                    <span class="c1"># index orders:</span>
                    <span class="c1"># EPW (Fortran): a, b, R&#39;, x, R</span>
                    <span class="c1"># after read-in: R, x, R&#39;, b, a</span>
                    <span class="c1"># after transp.: R, x, R&#39;, a, b</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: File &quot;</span><span class="si">%s</span><span class="s1">&quot; larger than expected!&#39;</span> <span class="o">%</span> <span class="n">epmatwp</span><span class="p">)</span>

            <span class="c1"># undo supercell double counting:</span>

            <span class="k">if</span> <span class="n">divide_ndegen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">divide_degeneracy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># divide by square root of atomic masses:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">lr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span> <span class="o">!=</span> <span class="n">divide_mass</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Inconsistent &#39;divide_mass&#39; in &#39;ph&#39; and &#39;elph&#39;!&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The value from &#39;ph&#39; (</span><span class="si">%r</span><span class="s2">) is used.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">)</span>
                <span class="n">divide_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">divide_mass</span>

            <span class="k">if</span> <span class="n">divide_mass</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">x</span> <span class="o">//</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Rk0</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">vector_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<div class="viewcode-block" id="Model.divide_degeneracy">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.divide_degeneracy">[docs]</a>
    <span class="k">def</span> <span class="nf">divide_degeneracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Divide real-space coupling by degeneracy of Wigner-Seitz point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        g : ndarray</span>
<span class="sd">            Real-space coupling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Standardized coupling has no Wigner-Seitz cell!&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">irk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">m</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">irk</span><span class="p">]:</span>
                        <span class="n">g</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">irk</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">irk</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">irk</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">irg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">3</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">M</span> <span class="o">=</span> <span class="n">m</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">N</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">irg</span><span class="p">]:</span>
                            <span class="n">g</span><span class="p">[</span><span class="n">irg</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">irg</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">g</span><span class="p">[</span><span class="n">irg</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></div>


<div class="viewcode-block" id="Model.sample_orig">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.sample_orig">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample coupling on original q and k meshes.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">nk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Set &quot;nk&quot; attribute of electron model first!&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">q0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">sample_orig</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">q0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span>
            <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.update_short_range">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.update_short_range">[docs]</a>
    <span class="k">def</span> <span class="nf">update_short_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update short-range part of real-space coupling.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Run &quot;sample_orig&quot; before changing Z, Q, etc.!&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
            <span class="n">q2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">prepare_long_range</span><span class="p">()</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SharedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span>
            <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">)</span>

        <span class="n">g_lr</span> <span class="o">=</span> <span class="n">dispersion</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_lr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">q0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">nk</span><span class="p">)):</span>
            <span class="n">g_lr</span> <span class="o">=</span> <span class="n">g_lr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g0</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">g</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">-=</span> <span class="n">g_lr</span>

        <span class="n">g</span><span class="o">.</span><span class="n">Bcast</span><span class="p">()</span>

        <span class="n">q2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">nq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.sample">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.sample">[docs]</a>
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample coupling.</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        sample</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.supercell">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.supercell">[docs]</a>
    <span class="k">def</span> <span class="nf">supercell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">N2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">N3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map localized model for electron-phonon coupling onto supercell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N1, N2, N3 : tuple of int or int, default 1</span>
<span class="sd">            Supercell lattice vectors in units of primitive lattice vectors.</span>
<span class="sd">        shared_memory : bool, default False</span>
<span class="sd">            Store mapped coupling in shared memory?</span>
<span class="sd">        sparse : bool, default False</span>
<span class="sd">            Only calculate q = k = 0 coupling as a list of sparse matrices to</span>
<span class="sd">            save memory? The result, which is assumed to be real, is stored in</span>
<span class="sd">            the attribute :attr:`gs`. Consider using :meth:`standardize` with</span>
<span class="sd">            nonzero `eps` and `symmetrize` before.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            Localized model for electron-phonon coupling for supercell.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        bravais.supercell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elph</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span>
            <span class="n">el</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">supercell</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span> <span class="n">N2</span><span class="p">,</span> <span class="n">N3</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">),</span>
            <span class="n">ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">supercell</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span> <span class="n">N2</span><span class="p">,</span> <span class="n">N3</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">))</span>

        <span class="n">supercell</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">supercell</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span> <span class="n">N2</span><span class="p">,</span> <span class="n">N3</span><span class="p">)</span>
        <span class="n">elph</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">supercell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">divide_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span>
        <span class="n">elph</span><span class="o">.</span><span class="n">divide_ndegen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_ndegen</span>

        <span class="n">const</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="n">sparse_array</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">get_sparse_array</span><span class="p">()</span>

            <span class="n">elph</span><span class="o">.</span><span class="n">gs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sparse_array</span><span class="p">((</span><span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
                <span class="n">g_lr</span> <span class="o">=</span> <span class="n">elph</span><span class="o">.</span><span class="n">g_lr</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>

                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">elph</span><span class="o">.</span><span class="n">gs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="n">g_lr</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">real</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning: Significant imaginary part of coupling ignored!&#39;</span><span class="p">)</span>

        <span class="n">Rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">//</span> <span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;map coupling onto supercell&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">cells</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
                <span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">rg</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">to_supercell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="n">elph</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">supercell</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)):</span>
                <span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">to_supercell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">elph</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">supercell</span><span class="p">)</span>

            <span class="n">A</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">rg</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)):</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="n">rk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span>

                    <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                            <span class="n">elph</span><span class="o">.</span><span class="n">gs</span><span class="p">[</span><span class="n">X</span> <span class="o">+</span> <span class="n">x</span><span class="p">][</span>
                                <span class="n">A</span><span class="p">:</span><span class="n">A</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                <span class="n">B</span><span class="p">:</span><span class="n">B</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
                        <span class="k">continue</span>

                    <span class="n">R</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">])</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">R</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                        <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                            <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

                    <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">][</span>
                        <span class="n">X</span><span class="p">:</span><span class="n">X</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                        <span class="n">A</span><span class="p">:</span><span class="n">A</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                        <span class="n">B</span><span class="p">:</span><span class="n">B</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>

                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="c1"># DOK/CSR format efficient for matrix construction/calculations:</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">elph</span><span class="o">.</span><span class="n">gs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">gs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

            <span class="n">elph</span><span class="o">.</span><span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">gs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pickle</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sparse representation of coupling requires </span><span class="si">%.6f</span><span class="s1"> GB&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">gs</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">elph</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">Rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">([</span><span class="n">R</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">]))))</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">Rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">([</span><span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">]))))</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">shared_array</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">)</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">gq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">Rk0</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">vector_index</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rg</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;convert supercell coupling to standard format&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">G3</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rg</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">K3</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">):</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">G3</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">K3</span>

                <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                            <span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span>

                    <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Reduce chunk-wise to avoid integer overflow for message size:</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
                <span class="n">elph</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">IN_PLACE</span><span class="p">,</span>
                    <span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">elph</span></div>


<div class="viewcode-block" id="Model.standardize">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.standardize">[docs]</a>
    <span class="k">def</span> <span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">symmetrize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Standardize real-space coupling data.</span>

<span class="sd">        - Keep only nonzero coupling matrices.</span>
<span class="sd">        - Sum over repeated lattice vectors.</span>
<span class="sd">        - Sort lattice vectors.</span>
<span class="sd">        - Optionally symmetrize coupling:</span>

<span class="sd">        .. math::</span>

<span class="sd">            g_{\vec q, \vec k} = g_{-\vec q, \vec k + \vec q}^\dagger,</span>
<span class="sd">            g_{\vec R, \vec R&#39;} = g_{\vec R - \vec R&#39;, -\vec R&#39;}^\dagger</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eps : float</span>
<span class="sd">            Threshold for &quot;nonzero&quot; matrix elements in units of the maximum</span>
<span class="sd">            matrix element.</span>
<span class="sd">        symmetrize : bool</span>
<span class="sd">            Symmetrize coupling?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">const</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;standardize coupling data&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">])</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                            <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">symmetrize</span><span class="p">:</span>
                            <span class="n">R</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                            <span class="n">g_adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

                            <span class="k">if</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                                <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">+=</span> <span class="n">g_adj</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">const</span><span class="p">[</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_adj</span>

                    <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">Rg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">R</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">))</span>
            <span class="n">Rk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">const</span><span class="p">))</span>

            <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Rg</span><span class="p">)</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Rk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ng</span> <span class="o">=</span> <span class="n">nk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ng</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">ng</span><span class="p">)</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ng</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[:</span><span class="n">ng</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ng</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nk</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[:</span><span class="n">nk</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ng</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="n">ng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">shared_array</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rk</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Rg</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Rk</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">const</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">Rg</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="n">Rk</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

                        <span class="k">if</span> <span class="n">symmetrize</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">2</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Rk0</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">vector_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span></div>


<div class="viewcode-block" id="Model.symmetrize">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.symmetrize">[docs]</a>
    <span class="k">def</span> <span class="nf">symmetrize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Symmetrize electron-phonon coupling.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">symmetrize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.asr">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.asr">[docs]</a>
    <span class="k">def</span> <span class="nf">asr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply acoustic sum rule correction to electron-phonon coupling.</span>

<span class="sd">        This will suppress all coupling of electrons to acoustic phonon modes.</span>
<span class="sd">        The matrix elements are subject to a constant relative change so that</span>
<span class="sd">        zeros remain zeros and the largest values change the most. There might</span>
<span class="sd">        be a better way to accomplish this.</span>

<span class="sd">        report : bool</span>
<span class="sd">            Print sums before and after correction?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoustic sum (before): </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="n">norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">norm</span><span class="p">[</span><span class="n">norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># corresponding &quot;zero&quot; really 0 by definition</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">zero</span>

            <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoustic sum (after): </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span></div>


<div class="viewcode-block" id="Model.decay_epmate">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.decay_epmate">[docs]</a>
    <span class="k">def</span> <span class="nf">decay_epmate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot maximum matrix element as a function of hopping distance.</span>

<span class="sd">        Use ``divide_mass=False`` to recreate EPW&#39;s *decay.epmate* file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Distances.</span>
<span class="sd">        ndarray</span>
<span class="sd">            Maximum absolute matrix elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">misc</span><span class="o">.</span><span class="n">a0</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">g</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">nonzero</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span></div>


<div class="viewcode-block" id="Model.decay_epmatp">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.decay_epmatp">[docs]</a>
    <span class="k">def</span> <span class="nf">decay_epmatp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot maximum matrix element as a function of displacement distance.</span>

<span class="sd">        Use ``divide_mass=False`` to recreate EPW&#39;s *decay.epmatp* file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Distances.</span>
<span class="sd">        ndarray</span>
<span class="sd">            Maximum absolute matrix elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">misc</span><span class="o">.</span><span class="n">a0</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">g</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">nonzero</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span></div>


<div class="viewcode-block" id="Model.to_epmatwp">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.Model.to_epmatwp">[docs]</a>
    <span class="k">def</span> <span class="nf">to_epmatwp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save coupling to *.epmatwp* and *.wigner* files.</span>

<span class="sd">        If :attr:`divide_ndegen`, the division by the degeneracies of the</span>
<span class="sd">        Wigner-Seitz points is not undone before writing the *.epmatwp* file.</span>
<span class="sd">        Instead, all degeneracies in the *.wiger* file are set to one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefix : str</span>
<span class="sd">            Filename stem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wigner&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_ndegen</span><span class="p">:</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="n">dims2</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">dk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">dims</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">dg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">dims2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dims</span><span class="p">,</span> <span class="n">dims2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">dk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span>
                    <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span>

                <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> 0 </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span> <span class="n">dims</span><span class="p">,</span> <span class="n">dims2</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">)):</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1"> </span><span class="si">%5d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">[</span><span class="n">ir</span><span class="p">]))</span>

                    <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dk</span><span class="p">[</span><span class="n">iw2</span><span class="p">,</span> <span class="n">iw</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">iw2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1"> </span><span class="si">%5d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">[</span><span class="n">ir</span><span class="p">]))</span>

                    <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">iw</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.epmatwp&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">epmatwp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rg</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
                            <span class="n">buf</span> <span class="o">=</span> <span class="n">epmatwp</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">na</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">na</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">buf</span> <span class="o">=</span> <span class="n">epmatwp</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">na</span><span class="p">]</span>

                        <span class="n">buf</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="sample">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.sample">[docs]</a>
<span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">shared_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample coupling for given q and k points and transform to band basis.</span>

<span class="sd">    One purpose of this routine is full control of the complex phase.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    g : function</span>
<span class="sd">        Electron-phonon coupling in the basis of electronic orbitals and</span>
<span class="sd">        Cartesian ionic displacements as a function of q and k in crystal</span>
<span class="sd">        coordinates with period :math:`2 \pi`.</span>
<span class="sd">    q : list of tuple</span>
<span class="sd">        List of q points in crystal coordinates :math:`q_i \in [0, 2 \pi)`.</span>
<span class="sd">    nk : int or tuple of int</span>
<span class="sd">        Number of k points per dimension, i.e., size of uniform mesh. Different</span>
<span class="sd">        numbers of k points along different axes can be specified via a tuple.</span>
<span class="sd">        Alternatively, `nk` is inferred from the shape of `U`.</span>
<span class="sd">    U : ndarray, optional</span>
<span class="sd">        Electron eigenvectors for given k mesh.</span>
<span class="sd">        If present, transform from orbital to band basis.</span>
<span class="sd">    u : ndarray, optional</span>
<span class="sd">        Phonon eigenvectors for given q points.</span>
<span class="sd">        If present, transform from displacement to band basis.</span>
<span class="sd">    squared : bool</span>
<span class="sd">        Sample squared complex modulus instead? This is more memory-efficient</span>
<span class="sd">        than sampling the complex coupling and taking the squared modulus later.</span>
<span class="sd">    broadcast : bool</span>
<span class="sd">        Broadcast result from rank 0 to all processes?</span>
<span class="sd">    shared_memory : bool, optional</span>
<span class="sd">        Store transformed coupling in shared memory?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

    <span class="n">nph</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">nk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nk</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="p">(</span><span class="n">nk</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">nk_orig</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nk</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">nk_orig</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nk_orig</span>

    <span class="n">q_orig</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">q_orig</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">q</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">q_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">q_orig</span>

    <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nel</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="p">(</span><span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nel</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nph</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">my_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">nph</span><span class="p">,</span> <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span> <span class="k">if</span> <span class="n">squared</span> <span class="k">else</span> <span class="nb">complex</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> <span class="o">*</span> <span class="n">nk</span><span class="o">.</span><span class="n">prod</span><span class="p">(),</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;sample coupling&#39;</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">nk</span>

    <span class="k">for</span> <span class="n">my_iq</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])):</span>
        <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>
        <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">,</span> <span class="n">Q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">K1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">KQ1</span> <span class="o">=</span> <span class="p">(</span><span class="n">K1</span> <span class="o">+</span> <span class="n">Q1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k1</span> <span class="o">=</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">K2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">KQ2</span> <span class="o">=</span> <span class="p">(</span><span class="n">K2</span> <span class="o">+</span> <span class="n">Q2</span><span class="p">)</span> <span class="o">%</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">k2</span> <span class="o">=</span> <span class="n">K2</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">K3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">KQ3</span> <span class="o">=</span> <span class="p">(</span><span class="n">K3</span> <span class="o">+</span> <span class="n">Q3</span><span class="p">)</span> <span class="o">%</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">k3</span> <span class="o">=</span> <span class="n">K3</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">gqk</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">gqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;am,xab,bn-&gt;xmn&#39;</span><span class="p">,</span>
                                <span class="n">U</span><span class="p">[</span><span class="n">KQ1</span><span class="p">,</span> <span class="n">KQ2</span><span class="p">,</span> <span class="n">KQ3</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">gqk</span><span class="p">,</span> <span class="n">U</span><span class="p">[</span><span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">K3</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">gqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xab,xu-&gt;uab&#39;</span><span class="p">,</span> <span class="n">gqk</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="n">iq</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">squared</span><span class="p">:</span>
                            <span class="n">gqk</span> <span class="o">*=</span> <span class="n">gqk</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                            <span class="n">gqk</span> <span class="o">=</span> <span class="n">gqk</span><span class="o">.</span><span class="n">real</span>

                        <span class="n">my_g</span><span class="p">[</span><span class="n">my_iq</span><span class="p">,</span> <span class="p">:,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">K3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gqk</span>

                    <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">shared_array</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">nph</span><span class="p">)</span> <span class="o">+</span> <span class="n">nk_orig</span> <span class="o">+</span> <span class="p">(</span><span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">my_g</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">,</span>
        <span class="n">single_memory</span><span class="o">=</span><span class="ow">not</span> <span class="n">broadcast</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">broadcast</span><span class="p">:</span> <span class="c1"># shared memory on single node</span>

        <span class="c1"># As Gatherv into shared memory can require more memory than expected</span>
        <span class="c1"># and lead to segmentation faults, we use a different approach here.</span>

        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span><span class="p">]:</span><span class="n">bounds</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">my_g</span><span class="p">,</span>
                        <span class="n">g</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span><span class="p">]:</span><span class="n">bounds</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">my_g</span>

                <span class="n">row</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">g</span>

    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">row</span><span class="o">.</span><span class="n">Gatherv</span><span class="p">(</span><span class="n">my_g</span><span class="p">,</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">my_g</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

    <span class="n">col</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span> <span class="c1"># should not be necessary</span>

    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
            <span class="n">images</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

    <span class="n">node</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="transform">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.transform">[docs]</a>
<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform q- and k-dependent coupling to band basis.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">nQ</span><span class="p">,</span> <span class="n">nph</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nel</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nph</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">my_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">nph</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">nk</span>

    <span class="k">for</span> <span class="n">my_iq</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])):</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">iq</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
            <span class="n">kq1</span> <span class="o">=</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">q1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nk</span>

            <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
                <span class="n">kq2</span> <span class="o">=</span> <span class="p">(</span><span class="n">k2</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span> <span class="o">%</span> <span class="n">nk</span>

                <span class="n">gqk</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

                <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;am,xab,bn-&gt;xmn&#39;</span><span class="p">,</span>
                        <span class="n">U</span><span class="p">[</span><span class="n">kq1</span><span class="p">,</span> <span class="n">kq2</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">gqk</span><span class="p">,</span> <span class="n">U</span><span class="p">[</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xab,xu-&gt;uab&#39;</span><span class="p">,</span> <span class="n">gqk</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="n">iq</span><span class="p">])</span>

                <span class="n">my_g</span><span class="p">[</span><span class="n">my_iq</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gqk</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">shared_array</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">nph</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">,</span> <span class="n">single_memory</span><span class="o">=</span><span class="ow">not</span> <span class="n">broadcast</span><span class="p">)</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Gatherv</span><span class="p">(</span><span class="n">my_g</span><span class="p">,</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">my_g</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">images</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

    <span class="n">node</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="q2r">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.q2r">[docs]</a>
<span class="k">def</span> <span class="nf">q2r</span><span class="p">(</span><span class="n">elph</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">divide_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fourier-transform electron-phonon coupling from reciprocal to real space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elph : object</span>
<span class="sd">        Localized model for electron-phonon coupling.</span>
<span class="sd">    nq, nk : tuple of int</span>
<span class="sd">        Number of q and k points along axes, i.e., shapes of uniform meshes.</span>
<span class="sd">    g : ndarray</span>
<span class="sd">        Electron-phonon coupling on complete uniform q- and k-point meshes.</span>
<span class="sd">    r : ndarray, optional</span>
<span class="sd">        Positions of orbital centers. If given, the Wigner-Seitz lattice vectors</span>
<span class="sd">        are determined again, whereby the distances to the displaced atom and</span>
<span class="sd">        the initial orbital are are both measured from the final orbital in the</span>
<span class="sd">        unit cell at the origin (first orbital index). This argument is required</span>
<span class="sd">        when changing `nq` or `nk`.</span>
<span class="sd">    divide_mass : bool, default True</span>
<span class="sd">        Has input coupling been divided by square root of atomic mass? This is</span>
<span class="sd">        independent of ``elph.divide_mass``, which is always respected.</span>
<span class="sd">    shared_memory : bool, default False</span>
<span class="sd">        Store real-space coupling in shared memory?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nq_orig</span> <span class="o">=</span> <span class="n">nq</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nq</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">nq_orig</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nq_orig</span>

    <span class="n">nk_orig</span> <span class="o">=</span> <span class="n">nk</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nk</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">nk_orig</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nk_orig</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">nq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">:</span><span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">:</span><span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="n">sizes</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">my_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span>
        <span class="n">nq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]:</span><span class="n">bounds</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]):</span>
        <span class="n">my_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">g</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">nu</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">nq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Gatherv</span><span class="p">(</span><span class="n">my_data</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">my_data</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elph</span><span class="o">.</span><span class="n">Rg</span><span class="p">,</span> <span class="n">ndegen_g</span><span class="p">,</span> <span class="n">wslen</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">wigner</span><span class="p">(</span><span class="n">nq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">dg</span> <span class="o">=</span> <span class="n">ndegen_g</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">,</span> <span class="n">ndegen_k</span><span class="p">,</span> <span class="n">wslen</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">wigner</span><span class="p">(</span><span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">dk</span> <span class="o">=</span> <span class="n">ndegen_k</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">shared_array</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rg</span><span class="p">),</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span><span class="p">),</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elph</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span> <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">irg</span><span class="p">,</span> <span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g3</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rg</span> <span class="o">%</span> <span class="n">nq</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">irk</span><span class="p">,</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">Rk</span> <span class="o">%</span> <span class="n">nk</span><span class="p">):</span>
                <span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">irg</span><span class="p">,</span> <span class="p">:,</span> <span class="n">irk</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g3</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">elph</span><span class="o">.</span><span class="n">divide_ndegen</span><span class="p">:</span>
            <span class="n">elph</span><span class="o">.</span><span class="n">divide_degeneracy</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">divide_mass</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elph</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">x</span> <span class="o">//</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">divide_mass</span> <span class="ow">and</span> <span class="n">elph</span><span class="o">.</span><span class="n">divide_mass</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">x</span> <span class="o">//</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">elph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">elph</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">elph</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span></div>


<div class="viewcode-block" id="coupling">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.coupling">[docs]</a>
<span class="k">def</span> <span class="nf">coupling</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">nQ</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">complete_k</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">phase</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read and complete electron-phonon matrix elements.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">Q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nQ</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nQ</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">sizes</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="n">nQ</span><span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span> <span class="k">if</span> <span class="n">phase</span> <span class="k">else</span> <span class="nb">float</span>

    <span class="n">elph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nQ</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">bands</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">my_elph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">bands</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">my_elph</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">my_Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Scatterv</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span> <span class="n">sizes</span><span class="p">),</span> <span class="n">my_Q</span><span class="p">)</span>

    <span class="n">band_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">phase</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_Q</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read data for q point </span><span class="si">%d</span><span class="s1">..&#39;</span> <span class="o">%</span> <span class="n">iq</span><span class="p">)</span>

        <span class="c1"># TypeError: &#39;test&#39; % 1</span>
        <span class="c1"># permitted: &#39;test&#39; % np.array(1)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">%</span> <span class="n">iq</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">jbnd</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">[</span><span class="n">band_slice</span><span class="p">]]</span>

                <span class="n">ibnd</span> <span class="o">-=</span> <span class="n">offset</span>
                <span class="n">jbnd</span> <span class="o">-=</span> <span class="n">offset</span>

                <span class="k">if</span> <span class="n">ibnd</span> <span class="o">&gt;=</span> <span class="n">bands</span> <span class="ow">or</span> <span class="n">jbnd</span> <span class="o">&gt;=</span> <span class="n">bands</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">indices</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span>

                <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
                    <span class="n">my_elph</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> \
                        <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">my_elph</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_Q</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Complete data for q point </span><span class="si">%d</span><span class="s1">..&#39;</span> <span class="o">%</span> <span class="n">iq</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ibnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">jbnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
                        <span class="n">bravais</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">my_elph</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">complete_k</span> <span class="ow">and</span> <span class="n">nq</span><span class="p">:</span> <span class="c1"># to be improved considerably</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Gatherv</span><span class="p">(</span><span class="n">my_elph</span><span class="p">,</span> <span class="p">(</span><span class="n">elph</span><span class="p">,</span> <span class="n">sizes</span> <span class="o">*</span> <span class="n">nmodes</span> <span class="o">*</span> <span class="n">nk</span> <span class="o">*</span> <span class="n">nk</span> <span class="o">*</span> <span class="n">bands</span> <span class="o">*</span> <span class="n">bands</span><span class="p">))</span>

        <span class="n">elph_complete</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">bands</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ibnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">jbnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
                        <span class="n">elph_complete</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">nu</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">bravais</span><span class="o">.</span><span class="n">complete_k</span><span class="p">(</span>
                                <span class="n">elph</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">],</span> <span class="n">nq</span><span class="p">))</span>

        <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">elph_complete</span><span class="p">)</span>
        <span class="n">elph</span> <span class="o">=</span> <span class="n">elph_complete</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Allgatherv</span><span class="p">(</span><span class="n">my_elph</span><span class="p">,</span>
            <span class="p">(</span><span class="n">elph</span><span class="p">,</span> <span class="n">sizes</span> <span class="o">*</span> <span class="n">nmodes</span> <span class="o">*</span> <span class="n">nk</span> <span class="o">*</span> <span class="n">nk</span> <span class="o">*</span> <span class="n">bands</span> <span class="o">*</span> <span class="n">bands</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">elph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">bands</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="n">elph</span></div>


<div class="viewcode-block" id="read_EPW_output">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.read_EPW_output">[docs]</a>
<span class="k">def</span> <span class="nf">read_EPW_output</span><span class="p">(</span><span class="n">epw_out</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">epf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">defpot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read electron-phonon coupling from EPW output file (using ``prtgkk``).</span>

<span class="sd">    Currently, the coupling must be defined on a uniform 2D k mesh</span>
<span class="sd">    (corresponding to triangular or square lattice).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    epw_out : str</span>
<span class="sd">        Name of EPW output file.</span>
<span class="sd">    q : list of int</span>
<span class="sd">        List of q points as integer recriprocal lattice units.</span>
<span class="sd">    nq : int</span>
<span class="sd">        Number of q points per dimension.</span>
<span class="sd">    nmodes : int</span>
<span class="sd">        Number of phonon modes.</span>
<span class="sd">    nk : int</span>
<span class="sd">        Number of k points per dimension.</span>
<span class="sd">    bands : int</span>
<span class="sd">        Number of electronic bands.</span>
<span class="sd">    eps : float</span>
<span class="sd">        Tolerance for q and k points.</span>
<span class="sd">    squeeze : bool</span>
<span class="sd">        In single-band case, skip dimensions of output arrary corresponding to</span>
<span class="sd">        electronic bands?</span>
<span class="sd">    status : bool</span>
<span class="sd">        Report currently processed q point?</span>
<span class="sd">    epf : bool</span>
<span class="sd">        Read real and imaginary part of the coupling of dimension energy to the</span>
<span class="sd">        power of 2/3 from last two columns? A modified version of EPW is needed.</span>
<span class="sd">        Otherwise, the modulus of the coupling of dimension energy is read.</span>
<span class="sd">    defpot : bool</span>
<span class="sd">        Multiply coupling by square root of twice the phonon energy to obtain a</span>
<span class="sd">        quantity of dimension energy to the power of 2/3?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">bands</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span> <span class="k">if</span> <span class="n">epf</span> <span class="k">else</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="p">[(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="k">for</span> <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="ow">in</span> <span class="n">q</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="n">elph</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">iq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">epw_out</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;     iq = &#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">q_set</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="n">iq</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="n">q1f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">nq</span>
                    <span class="n">q2f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">nq</span>

                    <span class="n">q1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">q1f</span><span class="p">))</span>
                    <span class="n">q2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">q2f</span><span class="p">))</span>

                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q1f</span> <span class="o">-</span> <span class="n">q1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eps</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q2f</span> <span class="o">-</span> <span class="n">q2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span> <span class="c1"># q in mesh?</span>
                        <span class="k">continue</span>

                    <span class="n">q1</span> <span class="o">%=</span> <span class="n">nq</span>
                    <span class="n">q2</span> <span class="o">%=</span> <span class="n">nq</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">q_set</span><span class="p">:</span> <span class="c1"># q among chosen irred. points?</span>
                        <span class="k">continue</span>

                    <span class="n">iq</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">))</span>
                    <span class="n">q_set</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q = (</span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">iq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;     ik = &#39;</span><span class="p">):</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="n">k1f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">nk</span>
                    <span class="n">k2f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">nk</span>

                    <span class="n">k1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k1f</span><span class="p">))</span>
                    <span class="n">k2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k2f</span><span class="p">))</span>

                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">k1f</span> <span class="o">-</span> <span class="n">k1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eps</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">k2f</span> <span class="o">-</span> <span class="n">k2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span> <span class="c1"># k in mesh?</span>
                        <span class="k">continue</span>

                    <span class="n">k1</span> <span class="o">%=</span> <span class="n">nk</span>
                    <span class="n">k2</span> <span class="o">%=</span> <span class="n">nk</span>

                    <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">jbnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">ibnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodes</span><span class="p">):</span>
                                <span class="n">columns</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                                <span class="k">if</span> <span class="n">epf</span><span class="p">:</span>
                                    <span class="n">elph</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">]</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">elif</span> <span class="n">defpot</span><span class="p">:</span>
                                    <span class="n">elph</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                                        <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                                            <span class="mi">2</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">elph</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                                        <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">elph</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: EPW output incomplete!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">epf</span> <span class="ow">or</span> <span class="n">defpot</span><span class="p">:</span>
            <span class="n">elph</span> <span class="o">*=</span> <span class="mf">1e-3</span> <span class="o">**</span> <span class="mf">1.5</span> <span class="c1"># meV^(3/2) to eV^(3/2)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elph</span> <span class="o">*=</span> <span class="mf">1e-3</span> <span class="c1"># meV to eV</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">elph</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">bands</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="n">elph</span></div>


<div class="viewcode-block" id="read_prtgkk">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.read_prtgkk">[docs]</a>
<span class="k">def</span> <span class="nf">read_prtgkk</span><span class="p">(</span><span class="n">epw_out</span><span class="p">,</span> <span class="n">nq</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nbnd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read frequencies and coupling from EPW output (using ``prtgkk``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    epw_out : str</span>
<span class="sd">        Name of EPW output file.</span>
<span class="sd">    nq : int</span>
<span class="sd">        Number of q points.</span>
<span class="sd">    nmodes : int</span>
<span class="sd">        Number of phonon modes.</span>
<span class="sd">    nk : int</span>
<span class="sd">        Number of k points.</span>
<span class="sd">    nbnd : int</span>
<span class="sd">        Number of electronic bands.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Phonon frequencies (meV).</span>
<span class="sd">    ndarray</span>
<span class="sd">        Electron-phonon coupling (meV).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">))</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nbnd</span><span class="p">,</span> <span class="n">nbnd</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">epw_out</span><span class="p">)</span> <span class="k">as</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;     iq = &#39;</span><span class="p">):</span>
                    <span class="n">ik</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">iq</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;     ik = &#39;</span><span class="p">):</span>
                    <span class="n">ik</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                    <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">jbnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbnd</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">ibnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbnd</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodes</span><span class="p">):</span>
                                <span class="n">columns</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                                <span class="n">w</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                                <span class="n">g</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">jbnd</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Bcast</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">g</span></div>


<div class="viewcode-block" id="read_patterns">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.read_patterns">[docs]</a>
<span class="k">def</span> <span class="nf">read_patterns</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nrep</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read XML files with displacement patterns from QE.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">sizes</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

    <span class="n">patterns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">nrep</span><span class="p">,</span> <span class="n">nrep</span><span class="p">))</span>

    <span class="n">my_patterns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">nrep</span><span class="p">,</span> <span class="n">nrep</span><span class="p">))</span>

    <span class="n">my_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Scatterv</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">sizes</span><span class="p">),</span> <span class="n">my_q</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">my_iq</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_q</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read displacement pattern for q point </span><span class="si">%d</span><span class="s1">..&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">goto</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">line</span>

            <span class="n">goto</span><span class="p">(</span><span class="s1">&#39;&lt;NUMBER_IRR_REP &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrong number of representations!&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">irep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrep</span><span class="p">):</span>
                <span class="n">goto</span><span class="p">(</span><span class="s1">&#39;&lt;DISPLACEMENT_PATTERN &#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">jrep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrep</span><span class="p">):</span>
                    <span class="n">my_patterns</span><span class="p">[</span><span class="n">my_iq</span><span class="p">,</span> <span class="n">irep</span><span class="p">,</span> <span class="n">jrep</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Allgatherv</span><span class="p">(</span><span class="n">my_patterns</span><span class="p">,</span> <span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">sizes</span> <span class="o">*</span> <span class="n">nrep</span> <span class="o">*</span> <span class="n">nrep</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">patterns</span></div>


<div class="viewcode-block" id="read_xml_files">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.read_xml_files">[docs]</a>
<span class="k">def</span> <span class="nf">read_xml_files</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">angle0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read XML files with coupling in displacement basis from QE (*nosym*).&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands</span><span class="p">]</span>

    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">translations</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle0</span><span class="p">)</span>

    <span class="n">sizes</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

    <span class="n">elph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="p">),</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="n">my_elph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="p">),</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="n">band_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">band_select</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
        <span class="n">band_select</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">my_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Scatterv</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">sizes</span><span class="p">),</span> <span class="n">my_q</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">my_iq</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_q</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read data for q point </span><span class="si">%d</span><span class="s1">..&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">my_irep</span><span class="p">,</span> <span class="n">irep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rep</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">goto</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">line</span>

                <span class="k">def</span> <span class="nf">intag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">goto</span><span class="p">(</span><span class="s1">&#39;&lt;NUMBER_OF_K&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">old</span> <span class="k">else</span> <span class="n">intag</span><span class="p">(</span><span class="n">tmp</span><span class="p">))))</span>
                <span class="k">if</span> <span class="n">nk</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrong number of k points!&#39;</span><span class="p">)</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">goto</span><span class="p">(</span><span class="s1">&#39;&lt;NUMBER_OF_BANDS&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">old</span> <span class="k">else</span> <span class="n">intag</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">nbands</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrong number of bands!&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span> <span class="o">*</span> <span class="n">nk</span><span class="p">):</span>
                    <span class="n">goto</span><span class="p">(</span><span class="s1">&#39;&lt;COORDINATES_XK&#39;</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()))[:</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">k1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nk</span><span class="p">))</span> <span class="o">%</span> <span class="n">nk</span>
                    <span class="n">k2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">*</span> <span class="n">nk</span><span class="p">))</span> <span class="o">%</span> <span class="n">nk</span>

                    <span class="n">goto</span><span class="p">(</span><span class="s1">&#39;&lt;PARTIAL_ELPH&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">band_select</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">band_select</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">my_elph</span><span class="p">[</span><span class="n">my_iq</span><span class="p">,</span> <span class="n">my_irep</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span>
                                    <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span>
                                        <span class="k">if</span> <span class="n">old</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))))</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">Allgatherv</span><span class="p">(</span><span class="n">my_elph</span><span class="p">,</span> <span class="p">(</span><span class="n">elph</span><span class="p">,</span>
        <span class="n">sizes</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span> <span class="o">*</span> <span class="n">nk</span> <span class="o">*</span> <span class="n">nk</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">elph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="n">elph</span></div>


<div class="viewcode-block" id="write_xml_files">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.write_xml_files">[docs]</a>
<span class="k">def</span> <span class="nf">write_xml_files</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">angle0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write XML files with coupling in displacement basis.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="n">nQ</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">nbands</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">translations</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle0</span><span class="p">)</span>
    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">bravais</span><span class="o">.</span><span class="n">reciprocals</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nQ</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">irep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodes</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xml</span><span class="p">:</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="s2">&lt;?iotk version=&quot;1.2.0&quot;?&gt;</span>
<span class="s2">&lt;?iotk file_version=&quot;1.0&quot;?&gt;</span>
<span class="s2">&lt;?iotk binary=&quot;F&quot;?&gt;</span>
<span class="s2">&lt;?iotk qe_syntax=&quot;F&quot;?&gt;</span>
<span class="s2">&lt;Root&gt;</span>
<span class="s2">  &lt;EL_PHON_HEADER&gt;</span>
<span class="s2">    &lt;DONE_ELPH type=&quot;logical&quot; size=&quot;1&quot;&gt;</span>
<span class="s2">      T</span>
<span class="s2">    &lt;/DONE_ELPH&gt;</span>
<span class="s2">  &lt;/EL_PHON_HEADER&gt;</span>
<span class="s2">  &lt;PARTIAL_EL_PHON&gt;</span>
<span class="s2">    &lt;NUMBER_OF_K type=&quot;integer&quot; size=&quot;1&quot;&gt;</span>
<span class="s2">      </span><span class="si">%d</span>
<span class="s2">    &lt;/NUMBER_OF_K&gt;</span>
<span class="s2">    &lt;NUMBER_OF_BANDS type=&quot;integer&quot; size=&quot;1&quot;&gt;</span>
<span class="s2">      </span><span class="si">%d</span>
<span class="s2">    &lt;/NUMBER_OF_BANDS&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nk</span> <span class="o">*</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nbands</span><span class="p">))</span>

                <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
                        <span class="n">ik</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">k1</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">b2</span><span class="p">)</span> <span class="o">/</span> <span class="n">nk</span>

                        <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;K_POINT.</span><span class="si">%d</span><span class="s2">&gt;</span>
<span class="s2">      &lt;COORDINATES_XK type=&quot;real&quot; size=&quot;3&quot; columns=&quot;3&quot;&gt;</span>
<span class="si">%23.15E</span><span class="s2"> </span><span class="si">%23.15E</span><span class="s2"> </span><span class="si">%23.15E</span>
<span class="s2">      &lt;/COORDINATES_XK&gt;</span>
<span class="s2">      &lt;PARTIAL_ELPH type=&quot;complex&quot; size=&quot;</span><span class="si">%d</span><span class="s2">&quot;&gt;&quot;&quot;&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">nbands</span> <span class="o">*</span> <span class="n">nbands</span><span class="p">))</span>

                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbands</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbands</span><span class="p">):</span>
                                <span class="n">g</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">irep</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">%23.15E</span><span class="s2">,</span><span class="si">%23.15E</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span>

                        <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      &lt;/PARTIAL_ELPH&gt;</span>
<span class="s2">    &lt;/K_POINT.</span><span class="si">%d</span><span class="s2">&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ik</span><span class="p">)</span>

                <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &lt;/PARTIAL_EL_PHON&gt;</span>
<span class="s2">&lt;/Root&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_data">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.write_data">[docs]</a>
<span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write array to ASCII file.&quot;&quot;&quot;</span>

    <span class="n">iterator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;multi_index&#39;</span><span class="p">])</span>

    <span class="n">complex_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">integer_format</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%%d</span><span class="s1">d&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%16.9e</span><span class="s1">&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">integer_format</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;C&#39;</span> <span class="k">if</span> <span class="n">complex_data</span> <span class="k">else</span> <span class="s1">&#39;R&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">integer_format</span> <span class="o">%</span> <span class="n">iterator</span><span class="o">.</span><span class="n">multi_index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">complex_data</span><span class="p">:</span>
                <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">float_format</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
                <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">float_format</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">float_format</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_data">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.read_data">[docs]</a>
<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read array to ASCII file.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">complex_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}[</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span> <span class="k">if</span> <span class="n">complex_data</span> <span class="k">else</span> <span class="nb">float</span><span class="p">)</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">columns</span><span class="p">[:</span><span class="n">ndim</span><span class="p">]))</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">ndim</span><span class="p">:]))</span>

            <span class="k">if</span> <span class="n">complex_data</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="ph2epw">
<a class="viewcode-back" href="../../modules/elph.html#elphmod.elph.ph2epw">[docs]</a>
<span class="k">def</span> <span class="nf">ph2epw</span><span class="p">(</span><span class="n">fildyn</span><span class="o">=</span><span class="s1">&#39;dyn&#39;</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;work&#39;</span><span class="p">,</span> <span class="n">dvscf_dir</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert PHonon output to EPW input.</span>

<span class="sd">    Based on script `pp.py` provided with EPW code (C) 2015 Samuel Ponce.</span>

<span class="sd">    All arguments can be overwritten by environment variables of the same name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dyn : str</span>
<span class="sd">        Prefix of dynamical-matrix files.</span>
<span class="sd">    outdir : str</span>
<span class="sd">        QE output directory.</span>
<span class="sd">    dvscf_dir : str</span>
<span class="sd">        EPW input directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">shutil</span>

    <span class="k">if</span> <span class="s1">&#39;fildyn&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">fildyn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;fildyn&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;outdir&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;dvscf_dir&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">dvscf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;dvscf_dir&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fildyn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">):</span>
        <span class="n">fildyn</span> <span class="o">=</span> <span class="n">fildyn</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.xml&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">1.xml&#39;</span> <span class="o">%</span> <span class="n">fildyn</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">1</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fildyn</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Usage: [fildyn=...] [outdir=...] [dvscf_dir=...] ph2epw&#39;</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">phsave</span><span class="p">,</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/_ph0/*.phsave&#39;</span> <span class="o">%</span> <span class="n">outdir</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">phsave</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/_ph0/&#39;</span> <span class="o">%</span> <span class="n">outdir</span><span class="p">):</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;.phsave&#39;</span><span class="p">)]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">phsave</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.phsave&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dvscf_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning: EPW dvscf_dir &quot;</span><span class="si">%s</span><span class="s1">&quot; already exists!&#39;</span> <span class="o">%</span> <span class="n">dvscf_dir</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dyn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fildyn</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dyn</span><span class="p">):</span>
            <span class="k">break</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">dyn</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.dyn_q</span><span class="si">%d%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dvscf_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>

        <span class="n">orig</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/_ph0&#39;</span> <span class="o">%</span> <span class="n">outdir</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">orig</span> <span class="o">+=</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">.q_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="s1">&#39;dvscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dvscf_paw&#39;</span><span class="p">:</span>
            <span class="n">origfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">origfile</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">origfile</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">_q</span><span class="si">%d</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">dvscf_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024 elphmod Developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>